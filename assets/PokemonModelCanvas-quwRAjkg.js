import{j as xe,r as Dn}from"./index-BOQkh8rq.js";import{D as ar,L as Rt,a as nt,b as ze,F as It,V as ce,M as Ke,S as cr,T as Wt,c as ye,d as Z,e as me,A as wt,f as Bn,g as Ze,h as Ae,i as ue,j as Lt,k as Gn,l as Hn,P as xt,O as jn,m as Un,n as Yt,o as At,p as Jt,G as Xe,Q as Me,q as ot,r as at,B as rt,s as ve,t as Et,u as vt,v as $t,w as Zt,x as Qt,y as Vn,z as en,R as Oe,E as ct,H as lt,I as lr,J as Ut,K as ur,N as ut,U as Qe,W as fr,X as dr,Y as hr,Z as Ve,_ as Vt,$ as pr,a0 as Kt,a1 as Kn,a2 as Ce,a3 as De,a4 as mr,a5 as gr,a6 as yr,a7 as Ct,a8 as Tr,a9 as br,aa as wr,ab as xr,ac as kt,ad as zn,ae as Ar,af as Er,ag as Ft,ah as Xn,ai as vr,aj as kr,ak as Rr,al as qn,am as Ir,an as Lr,ao as Wn,ap as _r,C as Mr,aq as tn}from"./react-three-fiber.esm-DdMB5BAl.js";class _n extends ar{constructor(e){super(e)}parse(e){function t(_){switch(_.image_type){case y:case v:if(_.colormap_length>256||_.colormap_size!==24||_.colormap_type!==1)throw new Error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case T:case x:case A:case L:if(_.colormap_type)throw new Error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case h:throw new Error("THREE.TGALoader: No data.");default:throw new Error("THREE.TGALoader: Invalid type "+_.image_type)}if(_.width<=0||_.height<=0)throw new Error("THREE.TGALoader: Invalid image size.");if(_.pixel_size!==8&&_.pixel_size!==16&&_.pixel_size!==24&&_.pixel_size!==32)throw new Error("THREE.TGALoader: Invalid pixel size "+_.pixel_size)}function s(_,le,ie,q,de){let te,re;const K=ie.pixel_size>>3,j=ie.width*ie.height*K;if(le&&(re=de.subarray(q,q+=ie.colormap_length*(ie.colormap_size>>3))),_){te=new Uint8Array(j);let P,M,D,oe=0;const Te=new Uint8Array(K);for(;oe<j;)if(P=de[q++],M=(P&127)+1,P&128){for(D=0;D<K;++D)Te[D]=de[q++];for(D=0;D<M;++D)te.set(Te,oe+D*K);oe+=K*M}else{for(M*=K,D=0;D<M;++D)te[oe+D]=de[q++];oe+=M}}else te=de.subarray(q,q+=le?ie.width*ie.height:j);return{pixel_data:te,palettes:re}}function n(_,le,ie,q,de,te,re,K,j){const P=j;let M,D=0,oe,Te;const Be=Y.width;for(Te=le;Te!==q;Te+=ie)for(oe=de;oe!==re;oe+=te,D++)M=K[D],_[(oe+Be*Te)*4+3]=255,_[(oe+Be*Te)*4+2]=P[M*3+0],_[(oe+Be*Te)*4+1]=P[M*3+1],_[(oe+Be*Te)*4+0]=P[M*3+2];return _}function r(_,le,ie,q,de,te,re,K){let j,P=0,M,D;const oe=Y.width;for(D=le;D!==q;D+=ie)for(M=de;M!==re;M+=te,P+=2)j=K[P+0]+(K[P+1]<<8),_[(M+oe*D)*4+0]=(j&31744)>>7,_[(M+oe*D)*4+1]=(j&992)>>2,_[(M+oe*D)*4+2]=(j&31)<<3,_[(M+oe*D)*4+3]=j&32768?0:255;return _}function i(_,le,ie,q,de,te,re,K){let j=0,P,M;const D=Y.width;for(M=le;M!==q;M+=ie)for(P=de;P!==re;P+=te,j+=3)_[(P+D*M)*4+3]=255,_[(P+D*M)*4+2]=K[j+0],_[(P+D*M)*4+1]=K[j+1],_[(P+D*M)*4+0]=K[j+2];return _}function o(_,le,ie,q,de,te,re,K){let j=0,P,M;const D=Y.width;for(M=le;M!==q;M+=ie)for(P=de;P!==re;P+=te,j+=4)_[(P+D*M)*4+2]=K[j+0],_[(P+D*M)*4+1]=K[j+1],_[(P+D*M)*4+0]=K[j+2],_[(P+D*M)*4+3]=K[j+3];return _}function l(_,le,ie,q,de,te,re,K){let j,P=0,M,D;const oe=Y.width;for(D=le;D!==q;D+=ie)for(M=de;M!==re;M+=te,P++)j=K[P],_[(M+oe*D)*4+0]=j,_[(M+oe*D)*4+1]=j,_[(M+oe*D)*4+2]=j,_[(M+oe*D)*4+3]=255;return _}function d(_,le,ie,q,de,te,re,K){let j=0,P,M;const D=Y.width;for(M=le;M!==q;M+=ie)for(P=de;P!==re;P+=te,j+=2)_[(P+D*M)*4+0]=K[j+0],_[(P+D*M)*4+1]=K[j+0],_[(P+D*M)*4+2]=K[j+0],_[(P+D*M)*4+3]=K[j+1];return _}function g(_,le,ie,q,de){let te,re,K,j,P,M;switch((Y.flags&H)>>R){default:case Q:te=0,K=1,P=le,re=0,j=1,M=ie;break;case B:te=0,K=1,P=le,re=ie-1,j=-1,M=-1;break;case ee:te=le-1,K=-1,P=-1,re=0,j=1,M=ie;break;case J:te=le-1,K=-1,P=-1,re=ie-1,j=-1,M=-1;break}if(Fe)switch(Y.pixel_size){case 8:l(_,re,j,M,te,K,P,q);break;case 16:d(_,re,j,M,te,K,P,q);break;default:throw new Error("THREE.TGALoader: Format not supported.")}else switch(Y.pixel_size){case 8:n(_,re,j,M,te,K,P,q,de);break;case 16:r(_,re,j,M,te,K,P,q);break;case 24:i(_,re,j,M,te,K,P,q);break;case 32:o(_,re,j,M,te,K,P,q);break;default:throw new Error("THREE.TGALoader: Format not supported.")}return _}const h=0,y=1,T=2,x=3,v=9,A=10,L=11,H=48,R=4,B=0,J=1,Q=2,ee=3;if(e.length<19)throw new Error("THREE.TGALoader: Not enough data to contain header.");let V=0;const z=new Uint8Array(e),Y={id_length:z[V++],colormap_type:z[V++],image_type:z[V++],colormap_index:z[V++]|z[V++]<<8,colormap_length:z[V++]|z[V++]<<8,colormap_size:z[V++],origin:[z[V++]|z[V++]<<8,z[V++]|z[V++]<<8],width:z[V++]|z[V++]<<8,height:z[V++]|z[V++]<<8,pixel_size:z[V++],flags:z[V++]};if(t(Y),Y.id_length+V>e.length)throw new Error("THREE.TGALoader: No data.");V+=Y.id_length;let $=!1,ke=!1,Fe=!1;switch(Y.image_type){case v:$=!0,ke=!0;break;case y:ke=!0;break;case A:$=!0;break;case T:break;case L:$=!0,Fe=!0;break;case x:Fe=!0;break}const qe=new Uint8Array(Y.width*Y.height*4),je=s($,ke,Y,V,z);return g(qe,Y.width,Y.height,je.pixel_data,je.palettes),{data:qe,width:Y.width,height:Y.height,flipY:!0,generateMipmaps:!0,minFilter:Rt}}}class Nr extends nt{load(e,t,s,n){const r=this,i=r.path===""?ze.extractUrlBase(e):r.path,o=new It(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,function(l){try{t(r.parse(l,i))}catch(d){n?n(d):console.error(d),r.manager.itemError(e)}},s,n)}parse(e,t){function s(c,a){const f=[],u=c.childNodes;for(let p=0,b=u.length;p<b;p++){const w=u[p];w.nodeName===a&&f.push(w)}return f}function n(c){if(c.length===0)return[];const a=c.trim().split(/\s+/),f=new Array(a.length);for(let u=0,p=a.length;u<p;u++)f[u]=a[u];return f}function r(c){if(c.length===0)return[];const a=c.trim().split(/\s+/),f=new Array(a.length);for(let u=0,p=a.length;u<p;u++)f[u]=parseFloat(a[u]);return f}function i(c){if(c.length===0)return[];const a=c.trim().split(/\s+/),f=new Array(a.length);for(let u=0,p=a.length;u<p;u++)f[u]=parseInt(a[u]);return f}function o(c){return c.substring(1)}function l(){return"three_default_"+ir++}function d(c){return Object.keys(c).length===0}function g(c){return{unit:h(s(c,"unit")[0]),upAxis:y(s(c,"up_axis")[0])}}function h(c){return c!==void 0&&c.hasAttribute("meter")===!0?parseFloat(c.getAttribute("meter")):1}function y(c){return c!==void 0?c.textContent:"Y_UP"}function T(c,a,f,u){const p=s(c,a)[0];if(p!==void 0){const b=s(p,f);for(let w=0;w<b.length;w++)u(b[w])}}function x(c,a){for(const f in c){const u=c[f];u.build=a(c[f])}}function v(c,a){return c.build!==void 0||(c.build=a(c)),c.build}function A(c){const a={sources:{},samplers:{},channels:{}};let f=!1;for(let u=0,p=c.childNodes.length;u<p;u++){const b=c.childNodes[u];if(b.nodeType!==1)continue;let w;switch(b.nodeName){case"source":w=b.getAttribute("id"),a.sources[w]=_t(b);break;case"sampler":w=b.getAttribute("id"),a.samplers[w]=L(b);break;case"channel":w=b.getAttribute("target"),a.channels[w]=H(b);break;case"animation":A(b),f=!0;break;default:console.log(b)}}f===!1&&(U.animations[c.getAttribute("id")||me.generateUUID()]=a)}function L(c){const a={inputs:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1&&p.nodeName==="input"){const b=o(p.getAttribute("source")),w=p.getAttribute("semantic");a.inputs[w]=b}}return a}function H(c){const a={};let u=c.getAttribute("target").split("/");const p=u.shift();let b=u.shift();const w=b.indexOf("(")!==-1,N=b.indexOf(".")!==-1;if(N)u=b.split("."),b=u.shift(),a.member=u.shift();else if(w){const k=b.split("(");b=k.shift();for(let I=0;I<k.length;I++)k[I]=parseInt(k[I].replace(/\)/,""));a.indices=k}return a.id=p,a.sid=b,a.arraySyntax=w,a.memberSyntax=N,a.sampler=o(c.getAttribute("source")),a}function R(c){const a=[],f=c.channels,u=c.samplers,p=c.sources;for(const b in f)if(f.hasOwnProperty(b)){const w=f[b],N=u[w.sampler],k=N.inputs.INPUT,I=N.inputs.OUTPUT,F=p[k],E=p[I],C=J(w,F,E);Y(C,a)}return a}function B(c){return v(U.animations[c],R)}function J(c,a,f){const u=U.nodes[c.id],p=Ye(u.id),b=u.transforms[c.sid],w=u.matrix.clone().transpose();let N,k,I,F,E,C;const S={};switch(b){case"matrix":for(I=0,F=a.array.length;I<F;I++)if(N=a.array[I],k=I*f.stride,S[N]===void 0&&(S[N]={}),c.arraySyntax===!0){const he=f.array[k],ae=c.indices[0]+4*c.indices[1];S[N][ae]=he}else for(E=0,C=f.stride;E<C;E++)S[N][E]=f.array[k+E];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break}const G=Q(S,w);return{name:p.uuid,keyframes:G}}function Q(c,a){const f=[];for(const p in c)f.push({time:parseFloat(p),value:c[p]});f.sort(u);for(let p=0;p<16;p++)$(f,p,a.elements[p]);return f;function u(p,b){return p.time-b.time}}const ee=new ce,V=new ce,z=new Me;function Y(c,a){const f=c.keyframes,u=c.name,p=[],b=[],w=[],N=[];for(let k=0,I=f.length;k<I;k++){const F=f[k],E=F.time,C=F.value;Ee.fromArray(C).transpose(),Ee.decompose(ee,z,V),p.push(E),b.push(ee.x,ee.y,ee.z),w.push(z.x,z.y,z.z,z.w),N.push(V.x,V.y,V.z)}return b.length>0&&a.push(new ot(u+".position",p,b)),w.length>0&&a.push(new at(u+".quaternion",p,w)),N.length>0&&a.push(new ot(u+".scale",p,N)),a}function $(c,a,f){let u,p=!0,b,w;for(b=0,w=c.length;b<w;b++)u=c[b],u.value[a]===void 0?u.value[a]=null:p=!1;if(p===!0)for(b=0,w=c.length;b<w;b++)u=c[b],u.value[a]=f;else ke(c,a)}function ke(c,a){let f,u;for(let p=0,b=c.length;p<b;p++){const w=c[p];if(w.value[a]===null){if(f=Fe(c,p,a),u=qe(c,p,a),f===null){w.value[a]=u.value[a];continue}if(u===null){w.value[a]=f.value[a];continue}je(w,f,u,a)}}}function Fe(c,a,f){for(;a>=0;){const u=c[a];if(u.value[f]!==null)return u;a--}return null}function qe(c,a,f){for(;a<c.length;){const u=c[a];if(u.value[f]!==null)return u;a++}return null}function je(c,a,f,u){if(f.time-a.time===0){c.value[u]=a.value[u];return}c.value[u]=(c.time-a.time)*(f.value[u]-a.value[u])/(f.time-a.time)+a.value[u]}function _(c){const a={name:c.getAttribute("id")||"default",start:parseFloat(c.getAttribute("start")||0),end:parseFloat(c.getAttribute("end")||0),animations:[]};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="instance_animation"&&a.animations.push(o(p.getAttribute("url")))}U.clips[c.getAttribute("id")]=a}function le(c){const a=[],f=c.name,u=c.end-c.start||-1,p=c.animations;for(let b=0,w=p.length;b<w;b++){const N=B(p[b]);for(let k=0,I=N.length;k<I;k++)a.push(N[k])}return new wt(f,u,a)}function ie(c){return v(U.clips[c],le)}function q(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"skin":a.id=o(p.getAttribute("source")),a.skin=de(p);break;case"morph":a.id=o(p.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}U.controllers[c.getAttribute("id")]=a}function de(c){const a={sources:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"bind_shape_matrix":a.bindShapeMatrix=r(p.textContent);break;case"source":const b=p.getAttribute("id");a.sources[b]=_t(p);break;case"joints":a.joints=te(p);break;case"vertex_weights":a.vertexWeights=re(p);break}}return a}function te(c){const a={inputs:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1&&p.nodeName==="input"){const b=p.getAttribute("semantic"),w=o(p.getAttribute("source"));a.inputs[b]=w}}return a}function re(c){const a={inputs:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"input":const b=p.getAttribute("semantic"),w=o(p.getAttribute("source")),N=parseInt(p.getAttribute("offset"));a.inputs[b]={id:w,offset:N};break;case"vcount":a.vcount=i(p.textContent);break;case"v":a.v=i(p.textContent);break}}return a}function K(c){const a={id:c.id},f=U.geometries[a.id];return c.skin!==void 0&&(a.skin=j(c.skin),f.sources.skinIndices=a.skin.indices,f.sources.skinWeights=a.skin.weights),a}function j(c){const f={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},u=c.sources,p=c.vertexWeights,b=p.vcount,w=p.v,N=p.inputs.JOINT.offset,k=p.inputs.WEIGHT.offset,I=c.sources[c.joints.inputs.JOINT],F=c.sources[c.joints.inputs.INV_BIND_MATRIX],E=u[p.inputs.WEIGHT.id].array;let C=0,S,G,O;for(S=0,O=b.length;S<O;S++){const ae=b[S],ne=[];for(G=0;G<ae;G++){const se=w[C+N],Pe=w[C+k],we=E[Pe];ne.push({index:se,weight:we}),C+=2}for(ne.sort(he),G=0;G<4;G++){const se=ne[G];se!==void 0?(f.indices.array.push(se.index),f.weights.array.push(se.weight)):(f.indices.array.push(0),f.weights.array.push(0))}}for(c.bindShapeMatrix?f.bindMatrix=new Z().fromArray(c.bindShapeMatrix).transpose():f.bindMatrix=new Z().identity(),S=0,O=I.array.length;S<O;S++){const ae=I.array[S],ne=new Z().fromArray(F.array,S*F.stride).transpose();f.joints.push({name:ae,boneInverse:ne})}return f;function he(ae,ne){return ne.weight-ae.weight}}function P(c){return v(U.controllers[c],K)}function M(c){const a={init_from:s(c,"init_from")[0].textContent};U.images[c.getAttribute("id")]=a}function D(c){return c.build!==void 0?c.build:c.init_from}function oe(c){const a=U.images[c];return a!==void 0?v(a,D):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",c),null)}function Te(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="profile_COMMON"&&(a.profile=Be(p))}U.effects[c.getAttribute("id")]=a}function Be(c){const a={surfaces:{},samplers:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"newparam":ht(p,a);break;case"technique":a.technique=cs(p);break;case"extra":a.extra=cn(p);break}}return a}function ht(c,a){const f=c.getAttribute("sid");for(let u=0,p=c.childNodes.length;u<p;u++){const b=c.childNodes[u];if(b.nodeType===1)switch(b.nodeName){case"surface":a.surfaces[f]=pt(b);break;case"sampler2D":a.samplers[f]=mt(b);break}}}function pt(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="init_from"&&(a.init_from=p.textContent)}return a}function mt(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="source"&&(a.source=p.textContent)}return a}function cs(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"constant":case"lambert":case"blinn":case"phong":a.type=p.nodeName,a.parameters=ls(p);break;case"extra":a.extra=cn(p);break}}return a}function ls(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":a[p.nodeName]=on(p);break;case"transparent":a[p.nodeName]={opaque:p.hasAttribute("opaque")?p.getAttribute("opaque"):"A_ONE",data:on(p)};break}}return a}function on(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"color":a[p.nodeName]=r(p.textContent);break;case"float":a[p.nodeName]=parseFloat(p.textContent);break;case"texture":a[p.nodeName]={id:p.getAttribute("texture"),extra:an(p)};break}}return a}function an(c){const a={technique:{}};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="extra"&&us(p,a)}return a}function us(c,a){for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="technique"&&fs(p,a)}}function fs(c,a){for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":a.technique[p.nodeName]=parseFloat(p.textContent);break;case"wrapU":case"wrapV":p.textContent.toUpperCase()==="TRUE"?a.technique[p.nodeName]=1:p.textContent.toUpperCase()==="FALSE"?a.technique[p.nodeName]=0:a.technique[p.nodeName]=parseInt(p.textContent);break;case"bump":a[p.nodeName]=ln(p);break}}}function cn(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="technique"&&(a.technique=ds(p))}return a}function ds(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"double_sided":a[p.nodeName]=parseInt(p.textContent);break;case"bump":a[p.nodeName]=ln(p);break}}return a}function ln(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="texture"&&(a[p.nodeName]={id:p.getAttribute("texture"),texcoord:p.getAttribute("texcoord"),extra:an(p)})}return a}function un(c){return c}function hs(c){return v(U.effects[c],un)}function ps(c){const a={name:c.getAttribute("name")};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="instance_effect"&&(a.url=o(p.getAttribute("url")))}U.materials[c.getAttribute("id")]=a}function ms(c){let a,f=c.slice((c.lastIndexOf(".")-1>>>0)+2);return f=f.toLowerCase(),f==="tga"?a=St:a=Rn,a}function fn(c){const a=hs(c.url),f=a.profile.technique;let u;switch(f.type){case"phong":case"blinn":u=new Ze;break;case"lambert":u=new Bn;break;default:u=new Ke;break}u.name=c.name||"";function p(k,I=null){const F=a.profile.samplers[k.id];let E=null;if(F!==void 0){const C=a.profile.surfaces[F.source];E=oe(C.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),E=oe(k.id);if(E!==null){const C=ms(E);if(C!==void 0){const S=C.load(E),G=k.extra;if(G!==void 0&&G.technique!==void 0&&d(G.technique)===!1){const O=G.technique;S.wrapS=O.wrapU?Oe:ct,S.wrapT=O.wrapV?Oe:ct,S.offset.set(O.offsetU||0,O.offsetV||0),S.repeat.set(O.repeatU||1,O.repeatV||1)}else S.wrapS=Oe,S.wrapT=Oe;return I!==null&&(S.colorSpace=I),S}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",E),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",k.id),null}const b=f.parameters;for(const k in b){const I=b[k];switch(k){case"diffuse":I.color&&u.color.fromArray(I.color),I.texture&&(u.map=p(I.texture,ue));break;case"specular":I.color&&u.specular&&u.specular.fromArray(I.color),I.texture&&(u.specularMap=p(I.texture));break;case"bump":I.texture&&(u.normalMap=p(I.texture));break;case"ambient":I.texture&&(u.lightMap=p(I.texture,ue));break;case"shininess":I.float&&u.shininess&&(u.shininess=I.float);break;case"emission":I.color&&u.emissive&&u.emissive.fromArray(I.color),I.texture&&(u.emissiveMap=p(I.texture,ue));break}}Ae.colorSpaceToWorking(u.color,ue),u.specular&&Ae.colorSpaceToWorking(u.specular,ue),u.emissive&&Ae.colorSpaceToWorking(u.emissive,ue);let w=b.transparent,N=b.transparency;if(N===void 0&&w&&(N={float:1}),w===void 0&&N&&(w={opaque:"A_ONE",data:{color:[1,1,1,1]}}),w&&N)if(w.data.texture)u.transparent=!0;else{const k=w.data.color;switch(w.opaque){case"A_ONE":u.opacity=k[3]*N.float;break;case"RGB_ZERO":u.opacity=1-k[0]*N.float;break;case"A_ZERO":u.opacity=1-k[3]*N.float;break;case"RGB_ONE":u.opacity=k[0]*N.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',w.opaque)}u.opacity<1&&(u.transparent=!0)}if(f.extra!==void 0&&f.extra.technique!==void 0){const k=f.extra.technique;for(const I in k){const F=k[I];switch(I){case"double_sided":u.side=F===1?Gn:Hn;break;case"bump":u.normalMap=p(F.texture),u.normalScale=new Lt(1,1);break}}}return u}function gs(c){return v(U.materials[c],fn)}function ys(c){const a={name:c.getAttribute("name")};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="optics"&&(a.optics=Ts(p))}U.cameras[c.getAttribute("id")]=a}function Ts(c){for(let a=0;a<c.childNodes.length;a++){const f=c.childNodes[a];if(f.nodeName==="technique_common")return bs(f)}return{}}function bs(c){const a={};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];switch(u.nodeName){case"perspective":case"orthographic":a.technique=u.nodeName,a.parameters=ws(u);break}}return a}function ws(c){const a={};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];switch(u.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":a[u.nodeName]=parseFloat(u.textContent);break}}return a}function dn(c){let a;switch(c.optics.technique){case"perspective":a=new xt(c.optics.parameters.yfov,c.optics.parameters.aspect_ratio,c.optics.parameters.znear,c.optics.parameters.zfar);break;case"orthographic":let f=c.optics.parameters.ymag,u=c.optics.parameters.xmag;const p=c.optics.parameters.aspect_ratio;u=u===void 0?f*p:u,f=f===void 0?u/p:f,u*=.5,f*=.5,a=new jn(-u,u,f,-f,c.optics.parameters.znear,c.optics.parameters.zfar);break;default:a=new xt;break}return a.name=c.name||"",a}function xs(c){const a=U.cameras[c];return a!==void 0?v(a,dn):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",c),null)}function As(c){let a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];p.nodeType===1&&p.nodeName==="technique_common"&&(a=Es(p))}U.lights[c.getAttribute("id")]=a}function Es(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"directional":case"point":case"spot":case"ambient":a.technique=p.nodeName,a.parameters=vs(p)}}return a}function vs(c){const a={};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"color":const b=r(p.textContent);a.color=new ye().fromArray(b),Ae.colorSpaceToWorking(a.color,ue);break;case"falloff_angle":a.falloffAngle=parseFloat(p.textContent);break;case"quadratic_attenuation":const w=parseFloat(p.textContent);a.distance=w?Math.sqrt(1/w):0;break}}return a}function hn(c){let a;switch(c.technique){case"directional":a=new Jt;break;case"point":a=new At;break;case"spot":a=new Yt;break;case"ambient":a=new Un;break}return c.parameters.color&&a.color.copy(c.parameters.color),c.parameters.distance&&(a.distance=c.parameters.distance),a}function ks(c){const a=U.lights[c];return a!==void 0?v(a,hn):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",c),null)}function Rs(c){const a={name:c.getAttribute("name"),sources:{},vertices:{},primitives:[]},f=s(c,"mesh")[0];if(f!==void 0){for(let u=0;u<f.childNodes.length;u++){const p=f.childNodes[u];if(p.nodeType!==1)continue;const b=p.getAttribute("id");switch(p.nodeName){case"source":a.sources[b]=_t(p);break;case"vertices":a.vertices=Is(p);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",p.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":a.primitives.push(Ls(p));break;default:console.log(p)}}U.geometries[c.getAttribute("id")]=a}}function _t(c){const a={array:[],stride:3};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"float_array":a.array=r(u.textContent);break;case"Name_array":a.array=n(u.textContent);break;case"technique_common":const p=s(u,"accessor")[0];p!==void 0&&(a.stride=parseInt(p.getAttribute("stride")));break}}return a}function Is(c){const a={};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];u.nodeType===1&&(a[u.getAttribute("semantic")]=o(u.getAttribute("source")))}return a}function Ls(c){const a={type:c.nodeName,material:c.getAttribute("material"),count:parseInt(c.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let f=0,u=c.childNodes.length;f<u;f++){const p=c.childNodes[f];if(p.nodeType===1)switch(p.nodeName){case"input":const b=o(p.getAttribute("source")),w=p.getAttribute("semantic"),N=parseInt(p.getAttribute("offset")),k=parseInt(p.getAttribute("set")),I=k>0?w+k:w;a.inputs[I]={id:b,offset:N},a.stride=Math.max(a.stride,N+1),w==="TEXCOORD"&&(a.hasUV=!0);break;case"vcount":a.vcount=i(p.textContent);break;case"p":a.p=i(p.textContent);break}}return a}function _s(c){const a={};for(let f=0;f<c.length;f++){const u=c[f];a[u.type]===void 0&&(a[u.type]=[]),a[u.type].push(u)}return a}function Ms(c){let a=0;for(let f=0,u=c.length;f<u;f++)c[f].hasUV===!0&&a++;a>0&&a<c.length&&(c.uvsNeedsFix=!0)}function pn(c){const a={},f=c.sources,u=c.vertices,p=c.primitives;if(p.length===0)return{};const b=_s(p);for(const w in b){const N=b[w];Ms(N),a[w]=Ns(N,f,u)}return a}function Ns(c,a,f){const u={},p={array:[],stride:0},b={array:[],stride:0},w={array:[],stride:0},N={array:[],stride:0},k={array:[],stride:0},I={array:[],stride:4},F={array:[],stride:4},E=new rt,C=[];let S=0;for(let G=0;G<c.length;G++){const O=c[G],he=O.inputs;let ae=0;switch(O.type){case"lines":case"linestrips":ae=O.count*2;break;case"triangles":ae=O.count*3;break;case"polylist":for(let ne=0;ne<O.count;ne++){const se=O.vcount[ne];switch(se){case 3:ae+=3;break;case 4:ae+=6;break;default:ae+=(se-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknown primitive type:",O.type)}E.addGroup(S,ae,G),S+=ae,O.material&&C.push(O.material);for(const ne in he){const se=he[ne];switch(ne){case"VERTEX":for(const Pe in f){const we=f[Pe];switch(Pe){case"POSITION":const Je=p.array.length;if(Le(O,a[we],se.offset,p.array),p.stride=a[we].stride,a.skinWeights&&a.skinIndices&&(Le(O,a.skinIndices,se.offset,I.array),Le(O,a.skinWeights,se.offset,F.array)),O.hasUV===!1&&c.uvsNeedsFix===!0){const or=(p.array.length-Je)/p.stride;for(let Ln=0;Ln<or;Ln++)w.array.push(0,0)}break;case"NORMAL":Le(O,a[we],se.offset,b.array),b.stride=a[we].stride;break;case"COLOR":Le(O,a[we],se.offset,k.array),k.stride=a[we].stride;break;case"TEXCOORD":Le(O,a[we],se.offset,w.array),w.stride=a[we].stride;break;case"TEXCOORD1":Le(O,a[we],se.offset,N.array),w.stride=a[we].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',Pe)}}break;case"NORMAL":Le(O,a[se.id],se.offset,b.array),b.stride=a[se.id].stride;break;case"COLOR":Le(O,a[se.id],se.offset,k.array,!0),k.stride=a[se.id].stride;break;case"TEXCOORD":Le(O,a[se.id],se.offset,w.array),w.stride=a[se.id].stride;break;case"TEXCOORD1":Le(O,a[se.id],se.offset,N.array),N.stride=a[se.id].stride;break}}}return p.array.length>0&&E.setAttribute("position",new ve(p.array,p.stride)),b.array.length>0&&E.setAttribute("normal",new ve(b.array,b.stride)),k.array.length>0&&E.setAttribute("color",new ve(k.array,k.stride)),w.array.length>0&&E.setAttribute("uv",new ve(w.array,w.stride)),N.array.length>0&&E.setAttribute("uv1",new ve(N.array,N.stride)),I.array.length>0&&E.setAttribute("skinIndex",new ve(I.array,I.stride)),F.array.length>0&&E.setAttribute("skinWeight",new ve(F.array,F.stride)),u.data=E,u.type=c[0].type,u.materialKeys=C,u}function Le(c,a,f,u,p=!1){const b=c.p,w=c.stride,N=c.vcount;function k(E){let C=b[E+f]*F;const S=C+F;for(;C<S;C++)u.push(I[C]);if(p){const G=u.length-F-1;gt.setRGB(u[G+0],u[G+1],u[G+2],ue),u[G+0]=gt.r,u[G+1]=gt.g,u[G+2]=gt.b}}const I=a.array,F=a.stride;if(c.vcount!==void 0){let E=0;for(let C=0,S=N.length;C<S;C++){const G=N[C];if(G===4){const O=E+w*0,he=E+w*1,ae=E+w*2,ne=E+w*3;k(O),k(he),k(ne),k(he),k(ae),k(ne)}else if(G===3){const O=E+w*0,he=E+w*1,ae=E+w*2;k(O),k(he),k(ae)}else if(G>4)for(let O=1,he=G-2;O<=he;O++){const ae=E+w*0,ne=E+w*O,se=E+w*(O+1);k(ae),k(ne),k(se)}E+=w*G}}else for(let E=0,C=b.length;E<C;E+=w)k(E)}function mn(c){return v(U.geometries[c],pn)}function Ss(c){const a={name:c.getAttribute("name")||"",joints:{},links:[]};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];u.nodeType===1&&u.nodeName==="technique_common"&&Ps(u,a)}U.kinematicsModels[c.getAttribute("id")]=a}function Cs(c){return c.build!==void 0?c.build:c}function Fs(c){return v(U.kinematicsModels[c],Cs)}function Ps(c,a){for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"joint":a.joints[u.getAttribute("sid")]=Os(u);break;case"link":a.links.push(gn(u));break}}}function Os(c){let a;for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"prismatic":case"revolute":a=Ds(u);break}}return a}function Ds(c){const a={sid:c.getAttribute("sid"),name:c.getAttribute("name")||"",axis:new ce,limits:{min:0,max:0},type:c.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"axis":const p=r(u.textContent);a.axis.fromArray(p);break;case"limits":const b=u.getElementsByTagName("max")[0],w=u.getElementsByTagName("min")[0];a.limits.max=parseFloat(b.textContent),a.limits.min=parseFloat(w.textContent);break}}return a.limits.min>=a.limits.max&&(a.static=!0),a.middlePosition=(a.limits.min+a.limits.max)/2,a}function gn(c){const a={sid:c.getAttribute("sid"),name:c.getAttribute("name")||"",attachments:[],transforms:[]};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"attachment_full":a.attachments.push(Bs(u));break;case"matrix":case"translate":case"rotate":a.transforms.push(yn(u));break}}return a}function Bs(c){const a={joint:c.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"link":a.links.push(gn(u));break;case"matrix":case"translate":case"rotate":a.transforms.push(yn(u));break}}return a}function yn(c){const a={type:c.nodeName},f=r(c.textContent);switch(a.type){case"matrix":a.obj=new Z,a.obj.fromArray(f).transpose();break;case"translate":a.obj=new ce,a.obj.fromArray(f);break;case"rotate":a.obj=new ce,a.obj.fromArray(f),a.angle=me.degToRad(f[3]);break}return a}function Gs(c){const a={name:c.getAttribute("name")||"",rigidBodies:{}};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];u.nodeType===1&&u.nodeName==="rigid_body"&&(a.rigidBodies[u.getAttribute("name")]={},Hs(u,a.rigidBodies[u.getAttribute("name")]))}U.physicsModels[c.getAttribute("id")]=a}function Hs(c,a){for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];u.nodeType===1&&u.nodeName==="technique_common"&&js(u,a)}}function js(c,a){for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1)switch(u.nodeName){case"inertia":a.inertia=r(u.textContent);break;case"mass":a.mass=r(u.textContent)[0];break}}}function Us(c){const a={bindJointAxis:[]};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];u.nodeType===1&&u.nodeName==="bind_joint_axis"&&a.bindJointAxis.push(Vs(u))}U.kinematicsScenes[o(c.getAttribute("url"))]=a}function Vs(c){const a={target:c.getAttribute("target").split("/").pop()};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType===1&&u.nodeName==="axis"){const p=u.getElementsByTagName("param")[0];a.axis=p.textContent;const b=a.axis.split("inst_").pop().split("axis")[0];a.jointIndex=b.substring(0,b.length-1)}}return a}function Ks(c){return c.build!==void 0?c.build:c}function zs(c){return v(U.kinematicsScenes[c],Ks)}function Xs(){const c=Object.keys(U.kinematicsModels)[0],a=Object.keys(U.kinematicsScenes)[0],f=Object.keys(U.visualScenes)[0];if(c===void 0||a===void 0)return;const u=Fs(c),p=zs(a),b=En(f),w=p.bindJointAxis,N={};for(let F=0,E=w.length;F<E;F++){const C=w[F],S=ge.querySelector('[sid="'+C.target+'"]');if(S){const G=S.parentElement;k(C.jointIndex,G)}}function k(F,E){const C=E.getAttribute("name"),S=u.joints[F];b.traverse(function(G){G.name===C&&(N[F]={object:G,transforms:qs(E),joint:S,position:S.zeroPosition})})}const I=new Z;In={joints:u&&u.joints,getJointValue:function(F){const E=N[F];if(E)return E.position;console.warn("THREE.ColladaLoader: Joint "+F+" doesn't exist.")},setJointValue:function(F,E){const C=N[F];if(C){const S=C.joint;if(E>S.limits.max||E<S.limits.min)console.warn("THREE.ColladaLoader: Joint "+F+" value "+E+" outside of limits (min: "+S.limits.min+", max: "+S.limits.max+").");else if(S.static)console.warn("THREE.ColladaLoader: Joint "+F+" is static.");else{const G=C.object,O=S.axis,he=C.transforms;Ee.identity();for(let ae=0;ae<he.length;ae++){const ne=he[ae];if(ne.sid&&ne.sid.indexOf(F)!==-1)switch(S.type){case"revolute":Ee.multiply(I.makeRotationAxis(O,me.degToRad(E)));break;case"prismatic":Ee.multiply(I.makeTranslation(O.x*E,O.y*E,O.z*E));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+S.type);break}else switch(ne.type){case"matrix":Ee.multiply(ne.obj);break;case"translate":Ee.multiply(I.makeTranslation(ne.obj.x,ne.obj.y,ne.obj.z));break;case"scale":Ee.scale(ne.obj);break;case"rotate":Ee.multiply(I.makeRotationAxis(ne.obj,ne.angle));break}}G.matrix.copy(Ee),G.matrix.decompose(G.position,G.quaternion,G.scale),N[F].position=E}}else console.log("THREE.ColladaLoader: "+F+" does not exist.")}}}function qs(c){const a=[],f=ge.querySelector('[id="'+c.id+'"]');for(let u=0;u<f.childNodes.length;u++){const p=f.childNodes[u];if(p.nodeType!==1)continue;let b,w;switch(p.nodeName){case"matrix":b=r(p.textContent);const N=new Z().fromArray(b).transpose();a.push({sid:p.getAttribute("sid"),type:p.nodeName,obj:N});break;case"translate":case"scale":b=r(p.textContent),w=new ce().fromArray(b),a.push({sid:p.getAttribute("sid"),type:p.nodeName,obj:w});break;case"rotate":b=r(p.textContent),w=new ce().fromArray(b);const k=me.degToRad(b[3]);a.push({sid:p.getAttribute("sid"),type:p.nodeName,obj:w,angle:k});break}}return a}function Ws(c){const a=c.getElementsByTagName("node");for(let f=0;f<a.length;f++){const u=a[f];u.hasAttribute("id")===!1&&u.setAttribute("id",l())}}const Ee=new Z,We=new ce;function Mt(c){const a={name:c.getAttribute("name")||"",type:c.getAttribute("type"),id:c.getAttribute("id"),sid:c.getAttribute("sid"),matrix:new Z,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];if(u.nodeType!==1)continue;let p;switch(u.nodeName){case"node":a.nodes.push(u.getAttribute("id")),Mt(u);break;case"instance_camera":a.instanceCameras.push(o(u.getAttribute("url")));break;case"instance_controller":a.instanceControllers.push(Tn(u));break;case"instance_light":a.instanceLights.push(o(u.getAttribute("url")));break;case"instance_geometry":a.instanceGeometries.push(Tn(u));break;case"instance_node":a.instanceNodes.push(o(u.getAttribute("url")));break;case"matrix":p=r(u.textContent),a.matrix.multiply(Ee.fromArray(p).transpose()),a.transforms[u.getAttribute("sid")]=u.nodeName;break;case"translate":p=r(u.textContent),We.fromArray(p),a.matrix.multiply(Ee.makeTranslation(We.x,We.y,We.z)),a.transforms[u.getAttribute("sid")]=u.nodeName;break;case"rotate":p=r(u.textContent);const b=me.degToRad(p[3]);a.matrix.multiply(Ee.makeRotationAxis(We.fromArray(p),b)),a.transforms[u.getAttribute("sid")]=u.nodeName;break;case"scale":p=r(u.textContent),a.matrix.scale(We.fromArray(p)),a.transforms[u.getAttribute("sid")]=u.nodeName;break;case"extra":break;default:console.log(u)}}return xn(a.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",a.id):U.nodes[a.id]=a,a}function Tn(c){const a={id:o(c.getAttribute("url")),materials:{},skeletons:[]};for(let f=0;f<c.childNodes.length;f++){const u=c.childNodes[f];switch(u.nodeName){case"bind_material":const p=u.getElementsByTagName("instance_material");for(let b=0;b<p.length;b++){const w=p[b],N=w.getAttribute("symbol"),k=w.getAttribute("target");a.materials[N]=o(k)}break;case"skeleton":a.skeletons.push(o(u.textContent));break}}return a}function Ys(c,a){const f=[],u=[];let p,b,w;for(p=0;p<c.length;p++){const I=c[p];let F;if(xn(I))F=Ye(I),bn(F,a,f);else if(er(I)){const C=U.visualScenes[I].children;for(let S=0;S<C.length;S++){const G=C[S];if(G.type==="JOINT"){const O=Ye(G.id);bn(O,a,f)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",I)}for(p=0;p<a.length;p++)for(b=0;b<f.length;b++)if(w=f[b],w.bone.name===a[p].name){u[p]=w,w.processed=!0;break}for(p=0;p<f.length;p++)w=f[p],w.processed===!1&&(u.push(w),w.processed=!0);const N=[],k=[];for(p=0;p<u.length;p++)w=u[p],N.push(w.bone),k.push(w.boneInverse);return new en(N,k)}function bn(c,a,f){c.traverse(function(u){if(u.isBone===!0){let p;for(let b=0;b<a.length;b++){const w=a[b];if(w.name===u.name){p=w.boneInverse;break}}p===void 0&&(p=new Z),f.push({bone:u,boneInverse:p,processed:!1})}})}function Js(c){const a=[],f=c.matrix,u=c.nodes,p=c.type,b=c.instanceCameras,w=c.instanceControllers,N=c.instanceLights,k=c.instanceGeometries,I=c.instanceNodes;for(let E=0,C=u.length;E<C;E++)a.push(Ye(u[E]));for(let E=0,C=b.length;E<C;E++){const S=xs(b[E]);S!==null&&a.push(S.clone())}for(let E=0,C=w.length;E<C;E++){const S=w[E],G=P(S.id),O=mn(G.id),he=wn(O,S.materials),ae=S.skeletons,ne=G.skin.joints,se=Ys(ae,ne);for(let Pe=0,we=he.length;Pe<we;Pe++){const Je=he[Pe];Je.isSkinnedMesh&&(Je.bind(se,G.skin.bindMatrix),Je.normalizeSkinWeights()),a.push(Je)}}for(let E=0,C=N.length;E<C;E++){const S=ks(N[E]);S!==null&&a.push(S.clone())}for(let E=0,C=k.length;E<C;E++){const S=k[E],G=mn(S.id),O=wn(G,S.materials);for(let he=0,ae=O.length;he<ae;he++)a.push(O[he])}for(let E=0,C=I.length;E<C;E++)a.push(Ye(I[E]).clone());let F;if(u.length===0&&a.length===1)F=a[0];else{F=p==="JOINT"?new Et:new Xe;for(let E=0;E<a.length;E++)F.add(a[E])}return F.name=p==="JOINT"?c.sid:c.name,F.matrix.copy(f),F.matrix.decompose(F.position,F.quaternion,F.scale),F}const $s=new Ke({name:nt.DEFAULT_MATERIAL_NAME,color:16711935});function Zs(c,a){const f=[];for(let u=0,p=c.length;u<p;u++){const b=a[c[u]];b===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",c[u]),f.push($s)):f.push(gs(b))}return f}function wn(c,a){const f=[];for(const u in c){const p=c[u],b=Zs(p.materialKeys,a);if(b.length===0&&(u==="lines"||u==="linestrips"?b.push(new vt):b.push(new Ze)),u==="lines"||u==="linestrips")for(let I=0,F=b.length;I<F;I++){const E=b[I];if(E.isMeshPhongMaterial===!0||E.isMeshLambertMaterial===!0){const C=new vt;C.color.copy(E.color),C.opacity=E.opacity,C.transparent=E.transparent,b[I]=C}}const w=p.data.attributes.skinIndex!==void 0,N=b.length===1?b[0]:b;let k;switch(u){case"lines":k=new Vn(p.data,N);break;case"linestrips":k=new Qt(p.data,N);break;case"triangles":case"polylist":w?k=new $t(p.data,N):k=new Zt(p.data,N);break}f.push(k)}return f}function xn(c){return U.nodes[c]!==void 0}function Ye(c){return v(U.nodes[c],Js)}function Qs(c){const a={name:c.getAttribute("name"),children:[]};Ws(c);const f=s(c,"node");for(let u=0;u<f.length;u++)a.children.push(Mt(f[u]));U.visualScenes[c.getAttribute("id")]=a}function An(c){const a=new Xe;a.name=c.name;const f=c.children;for(let u=0;u<f.length;u++){const p=f[u];a.add(Ye(p.id))}return a}function er(c){return U.visualScenes[c]!==void 0}function En(c){return v(U.visualScenes[c],An)}function tr(c){const a=s(c,"instance_visual_scene")[0];return En(o(a.getAttribute("url")))}function nr(){const c=U.clips;if(d(c)===!0){if(d(U.animations)===!1){const a=[];for(const f in U.animations){const u=B(f);for(let p=0,b=u.length;p<b;p++)a.push(u[p])}yt.push(new wt("default",-1,a))}}else for(const a in c)yt.push(ie(a))}function sr(c){let a="";const f=[c];for(;f.length;){const u=f.shift();u.nodeType===Node.TEXT_NODE?a+=u.textContent:(a+=`
`,f.push(...u.childNodes))}return a.trim()}if(e.length===0)return{scene:new cr};const vn=new DOMParser().parseFromString(e,"application/xml"),ge=s(vn,"COLLADA")[0],Nt=vn.getElementsByTagName("parsererror")[0];if(Nt!==void 0){const c=s(Nt,"div")[0];let a;return c?a=c.textContent:a=sr(Nt),console.error(`THREE.ColladaLoader: Failed to parse collada file.
`,a),null}const rr=ge.getAttribute("version");console.debug("THREE.ColladaLoader: File version",rr);const kn=g(s(ge,"asset")[0]),Rn=new Wt(this.manager);Rn.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);let St;_n&&(St=new _n(this.manager),St.setPath(this.resourcePath||t));const gt=new ye,yt=[];let In={},ir=0;const U={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};T(ge,"library_animations","animation",A),T(ge,"library_animation_clips","animation_clip",_),T(ge,"library_controllers","controller",q),T(ge,"library_images","image",M),T(ge,"library_effects","effect",Te),T(ge,"library_materials","material",ps),T(ge,"library_cameras","camera",ys),T(ge,"library_lights","light",As),T(ge,"library_geometries","geometry",Rs),T(ge,"library_nodes","node",Mt),T(ge,"library_visual_scenes","visual_scene",Qs),T(ge,"library_kinematics_models","kinematics_model",Ss),T(ge,"library_physics_models","physics_model",Gs),T(ge,"scene","instance_kinematics_scene",Us),x(U.animations,R),x(U.clips,le),x(U.controllers,K),x(U.images,D),x(U.effects,un),x(U.materials,fn),x(U.cameras,dn),x(U.lights,hn),x(U.geometries,pn),x(U.visualScenes,An),nr(),Xs();const Tt=tr(s(ge,"scene")[0]);return Tt.animations=yt,kn.upAxis==="Z_UP"&&(console.warn("THREE.ColladaLoader: You are loading an asset with a Z-UP coordinate system. The loader just rotates the asset to transform it into Y-UP. The vertex data are not converted, see #24289."),Tt.rotation.set(-Math.PI/2,0,0)),Tt.scale.multiplyScalar(kn.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),yt},kinematics:In,library:U,scene:Tt}}}var Ie=Uint8Array,et=Uint16Array,Sr=Int32Array,Yn=new Ie([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Jn=new Ie([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Cr=new Ie([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$n=function(m,e){for(var t=new et(31),s=0;s<31;++s)t[s]=e+=1<<m[s-1];for(var n=new Sr(t[30]),s=1;s<30;++s)for(var r=t[s];r<t[s+1];++r)n[r]=r-t[s]<<5|s;return{b:t,r:n}},Zn=$n(Yn,2),Qn=Zn.b,Fr=Zn.r;Qn[28]=258,Fr[258]=28;var Pr=$n(Jn,0),Or=Pr.b,zt=new et(32768);for(var fe=0;fe<32768;++fe){var Ge=(fe&43690)>>1|(fe&21845)<<1;Ge=(Ge&52428)>>2|(Ge&13107)<<2,Ge=(Ge&61680)>>4|(Ge&3855)<<4,zt[fe]=((Ge&65280)>>8|(Ge&255)<<8)>>1}var it=(function(m,e,t){for(var s=m.length,n=0,r=new et(e);n<s;++n)m[n]&&++r[m[n]-1];var i=new et(e);for(n=1;n<e;++n)i[n]=i[n-1]+r[n-1]<<1;var o;if(t){o=new et(1<<e);var l=15-e;for(n=0;n<s;++n)if(m[n])for(var d=n<<4|m[n],g=e-m[n],h=i[m[n]-1]++<<g,y=h|(1<<g)-1;h<=y;++h)o[zt[h]>>l]=d}else for(o=new et(s),n=0;n<s;++n)m[n]&&(o[n]=zt[i[m[n]-1]++]>>15-m[n]);return o}),dt=new Ie(288);for(var fe=0;fe<144;++fe)dt[fe]=8;for(var fe=144;fe<256;++fe)dt[fe]=9;for(var fe=256;fe<280;++fe)dt[fe]=7;for(var fe=280;fe<288;++fe)dt[fe]=8;var es=new Ie(32);for(var fe=0;fe<32;++fe)es[fe]=5;var Dr=it(dt,9,1),Br=it(es,5,1),Pt=function(m){for(var e=m[0],t=1;t<m.length;++t)m[t]>e&&(e=m[t]);return e},_e=function(m,e,t){var s=e/8|0;return(m[s]|m[s+1]<<8)>>(e&7)&t},Ot=function(m,e){var t=e/8|0;return(m[t]|m[t+1]<<8|m[t+2]<<16)>>(e&7)},Gr=function(m){return(m+7)/8|0},Hr=function(m,e,t){return(t==null||t>m.length)&&(t=m.length),new Ie(m.subarray(e,t))},jr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ne=function(m,e,t){var s=new Error(e||jr[m]);if(s.code=m,Error.captureStackTrace&&Error.captureStackTrace(s,Ne),!t)throw s;return s},Ur=function(m,e,t,s){var n=m.length,r=0;if(!n||e.f&&!e.l)return t||new Ie(0);var i=!t,o=i||e.i!=2,l=e.i;i&&(t=new Ie(n*3));var d=function(ht){var pt=t.length;if(ht>pt){var mt=new Ie(Math.max(pt*2,ht));mt.set(t),t=mt}},g=e.f||0,h=e.p||0,y=e.b||0,T=e.l,x=e.d,v=e.m,A=e.n,L=n*8;do{if(!T){g=_e(m,h,1);var H=_e(m,h+1,3);if(h+=3,H)if(H==1)T=Dr,x=Br,v=9,A=5;else if(H==2){var Q=_e(m,h,31)+257,ee=_e(m,h+10,15)+4,V=Q+_e(m,h+5,31)+1;h+=14;for(var z=new Ie(V),Y=new Ie(19),$=0;$<ee;++$)Y[Cr[$]]=_e(m,h+$*3,7);h+=ee*3;for(var ke=Pt(Y),Fe=(1<<ke)-1,qe=it(Y,ke,1),$=0;$<V;){var je=qe[_e(m,h,Fe)];h+=je&15;var R=je>>4;if(R<16)z[$++]=R;else{var _=0,le=0;for(R==16?(le=3+_e(m,h,3),h+=2,_=z[$-1]):R==17?(le=3+_e(m,h,7),h+=3):R==18&&(le=11+_e(m,h,127),h+=7);le--;)z[$++]=_}}var ie=z.subarray(0,Q),q=z.subarray(Q);v=Pt(ie),A=Pt(q),T=it(ie,v,1),x=it(q,A,1)}else Ne(1);else{var R=Gr(h)+4,B=m[R-4]|m[R-3]<<8,J=R+B;if(J>n){l&&Ne(0);break}o&&d(y+B),t.set(m.subarray(R,J),y),e.b=y+=B,e.p=h=J*8,e.f=g;continue}if(h>L){l&&Ne(0);break}}o&&d(y+131072);for(var de=(1<<v)-1,te=(1<<A)-1,re=h;;re=h){var _=T[Ot(m,h)&de],K=_>>4;if(h+=_&15,h>L){l&&Ne(0);break}if(_||Ne(2),K<256)t[y++]=K;else if(K==256){re=h,T=null;break}else{var j=K-254;if(K>264){var $=K-257,P=Yn[$];j=_e(m,h,(1<<P)-1)+Qn[$],h+=P}var M=x[Ot(m,h)&te],D=M>>4;M||Ne(3),h+=M&15;var q=Or[D];if(D>3){var P=Jn[D];q+=Ot(m,h)&(1<<P)-1,h+=P}if(h>L){l&&Ne(0);break}o&&d(y+131072);var oe=y+j;if(y<q){var Te=r-q,Be=Math.min(q,oe);for(Te+y<0&&Ne(3);y<Be;++y)t[y]=s[Te+y]}for(;y<oe;++y)t[y]=t[y-q]}}e.l=T,e.p=re,e.b=y,e.f=g,T&&(g=1,e.m=v,e.d=x,e.n=A)}while(!g);return y!=t.length&&i?Hr(t,0,y):t.subarray(0,y)},Vr=new Ie(0),Kr=function(m,e){return((m[0]&15)!=8||m[0]>>4>7||(m[0]<<8|m[1])%31)&&Ne(6,"invalid zlib data"),(m[1]>>5&1)==1&&Ne(6,"invalid zlib data: "+(m[1]&32?"need":"unexpected")+" dictionary"),(m[1]>>3&4)+2};function zr(m,e){return Ur(m.subarray(Kr(m),-4),{i:2},e,e)}var Xr=typeof TextDecoder<"u"&&new TextDecoder,qr=0;try{Xr.decode(Vr,{stream:!0}),qr=1}catch{}function ts(m,e,t){const s=t.length-m-1;if(e>=t[s])return s-1;if(e<=t[m])return m;let n=m,r=s,i=Math.floor((n+r)/2);for(;e<t[i]||e>=t[i+1];)e<t[i]?r=i:n=i,i=Math.floor((n+r)/2);return i}function Wr(m,e,t,s){const n=[],r=[],i=[];n[0]=1;for(let o=1;o<=t;++o){r[o]=e-s[m+1-o],i[o]=s[m+o]-e;let l=0;for(let d=0;d<o;++d){const g=i[d+1],h=r[o-d],y=n[d]/(g+h);n[d]=l+g*y,l=h*y}n[o]=l}return n}function Yr(m,e,t,s){const n=ts(m,s,e),r=Wr(n,s,m,e),i=new lt(0,0,0,0);for(let o=0;o<=m;++o){const l=t[n-m+o],d=r[o],g=l.w*d;i.x+=l.x*g,i.y+=l.y*g,i.z+=l.z*g,i.w+=l.w*d}return i}function Jr(m,e,t,s,n){const r=[];for(let h=0;h<=t;++h)r[h]=0;const i=[];for(let h=0;h<=s;++h)i[h]=r.slice(0);const o=[];for(let h=0;h<=t;++h)o[h]=r.slice(0);o[0][0]=1;const l=r.slice(0),d=r.slice(0);for(let h=1;h<=t;++h){l[h]=e-n[m+1-h],d[h]=n[m+h]-e;let y=0;for(let T=0;T<h;++T){const x=d[T+1],v=l[h-T];o[h][T]=x+v;const A=o[T][h-1]/o[h][T];o[T][h]=y+x*A,y=v*A}o[h][h]=y}for(let h=0;h<=t;++h)i[0][h]=o[h][t];for(let h=0;h<=t;++h){let y=0,T=1;const x=[];for(let v=0;v<=t;++v)x[v]=r.slice(0);x[0][0]=1;for(let v=1;v<=s;++v){let A=0;const L=h-v,H=t-v;h>=v&&(x[T][0]=x[y][0]/o[H+1][L],A=x[T][0]*o[L][H]);const R=L>=-1?1:-L,B=h-1<=H?v-1:t-h;for(let Q=R;Q<=B;++Q)x[T][Q]=(x[y][Q]-x[y][Q-1])/o[H+1][L+Q],A+=x[T][Q]*o[L+Q][H];h<=H&&(x[T][v]=-x[y][v-1]/o[H+1][h],A+=x[T][v]*o[h][H]),i[v][h]=A;const J=y;y=T,T=J}}let g=t;for(let h=1;h<=s;++h){for(let y=0;y<=t;++y)i[h][y]*=g;g*=t-h}return i}function $r(m,e,t,s,n){const r=n<m?n:m,i=[],o=ts(m,s,e),l=Jr(o,s,m,r,e),d=[];for(let g=0;g<t.length;++g){const h=t[g].clone(),y=h.w;h.x*=y,h.y*=y,h.z*=y,d[g]=h}for(let g=0;g<=r;++g){const h=d[o-m].clone().multiplyScalar(l[g][0]);for(let y=1;y<=m;++y)h.add(d[o-m+y].clone().multiplyScalar(l[g][y]));i[g]=h}for(let g=r+1;g<=n+1;++g)i[g]=new lt(0,0,0);return i}function Zr(m,e){let t=1;for(let n=2;n<=m;++n)t*=n;let s=1;for(let n=2;n<=e;++n)s*=n;for(let n=2;n<=m-e;++n)s*=n;return t/s}function Qr(m){const e=m.length,t=[],s=[];for(let r=0;r<e;++r){const i=m[r];t[r]=new ce(i.x,i.y,i.z),s[r]=i.w}const n=[];for(let r=0;r<e;++r){const i=t[r].clone();for(let o=1;o<=r;++o)i.sub(n[r-o].clone().multiplyScalar(Zr(r,o)*s[o]));n[r]=i.divideScalar(s[0])}return n}function ei(m,e,t,s,n){const r=$r(m,e,t,s,n);return Qr(r)}class ti extends lr{constructor(e,t,s,n,r){super();const i=t?t.length-1:0,o=s?s.length:0;this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=r||i;for(let l=0;l<o;++l){const d=s[l];this.controlPoints[l]=new lt(d.x,d.y,d.z,d.w)}}getPoint(e,t=new ce){const s=t,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=Yr(this.degree,this.knots,this.controlPoints,n);return r.w!==1&&r.divideScalar(r.w),s.set(r.x,r.y,r.z)}getTangent(e,t=new ce){const s=t,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=ei(this.degree,this.knots,this.controlPoints,n,1);return s.copy(r[1]).normalize(),s}toJSON(){const e=super.toJSON();return e.degree=this.degree,e.knots=[...this.knots],e.controlPoints=this.controlPoints.map(t=>t.toArray()),e.startKnot=this.startKnot,e.endKnot=this.endKnot,e}fromJSON(e){return super.fromJSON(e),this.degree=e.degree,this.knots=[...e.knots],this.controlPoints=e.controlPoints.map(t=>new lt(t[0],t[1],t[2],t[3])),this.startKnot=e.startKnot,this.endKnot=e.endKnot,this}}let X,pe,be;class ni extends nt{constructor(e){super(e)}load(e,t,s,n){const r=this,i=r.path===""?ze.extractUrlBase(e):r.path,o=new It(this.manager);o.setPath(r.path),o.setResponseType("arraybuffer"),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,function(l){try{t(r.parse(l,i))}catch(d){n?n(d):console.error(d),r.manager.itemError(e)}},s,n)}parse(e,t){if(ci(e))X=new ai().parse(e);else{const n=rs(e);if(!li(n))throw new Error("THREE.FBXLoader: Unknown format.");if(Nn(n)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Nn(n));X=new oi().parse(n)}const s=new Wt(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new si(s,this.manager).parse(X)}}class si{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){pe=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),s=this.parseMaterials(t),n=this.parseDeformers(),r=new ri().parse(n);return this.parseScene(n,r,s),be}parseConnections(){const e=new Map;return"Connections"in X&&X.Connections.connections.forEach(function(s){const n=s[0],r=s[1],i=s[2];e.has(n)||e.set(n,{parents:[],children:[]});const o={ID:r,relationship:i};e.get(n).parents.push(o),e.has(r)||e.set(r,{parents:[],children:[]});const l={ID:n,relationship:i};e.get(r).children.push(l)}),e}parseImages(){const e={},t={};if("Video"in X.Objects){const s=X.Objects.Video;for(const n in s){const r=s[n],i=parseInt(n);if(e[i]=r.RelativeFilename||r.Filename,"Content"in r){const o=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,l=typeof r.Content=="string"&&r.Content!=="";if(o||l){const d=this.parseImage(s[n]);t[r.RelativeFilename||r.Filename]=d}}}}for(const s in e){const n=e[s];t[n]!==void 0?e[s]=t[n]:e[s]=e[s].split("\\").pop()}return e}parseImage(e){const t=e.Content,s=e.RelativeFilename||e.Filename,n=s.slice(s.lastIndexOf(".")+1).toLowerCase();let r;switch(n){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",s),r="image/tga";break;case"webp":r="image/webp";break;default:console.warn('FBXLoader: Image type "'+n+'" is not supported.');return}if(typeof t=="string")return"data:"+r+";base64,"+t;{const i=new Uint8Array(t);return window.URL.createObjectURL(new Blob([i],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in X.Objects){const s=X.Objects.Texture;for(const n in s){const r=this.parseTexture(s[n],e);t.set(parseInt(n),r)}}return t}parseTexture(e,t){const s=this.loadTexture(e,t);s.ID=e.id,s.name=e.attrName;const n=e.WrapModeU,r=e.WrapModeV,i=n!==void 0?n.value:0,o=r!==void 0?r.value:0;if(s.wrapS=i===0?Oe:ct,s.wrapT=o===0?Oe:ct,"Scaling"in e){const l=e.Scaling.value;s.repeat.x=l[0],s.repeat.y=l[1]}if("Translation"in e){const l=e.Translation.value;s.offset.x=l[0],s.offset.y=l[1]}return s}loadTexture(e,t){const s=e.FileName.split(".").pop().toLowerCase();let n=this.manager.getHandler(`.${s}`);n===null&&(n=this.textureLoader);const r=n.path;r||n.setPath(this.textureLoader.path);const i=pe.get(e.id).children;let o;if(i!==void 0&&i.length>0&&t[i[0].ID]!==void 0&&(o=t[i[0].ID],(o.indexOf("blob:")===0||o.indexOf("data:")===0)&&n.setPath(void 0)),o===void 0)return console.warn("FBXLoader: Undefined filename, creating placeholder texture."),new Ut;const l=n.load(o);return n.setPath(r),l}parseMaterials(e){const t=new Map;if("Material"in X.Objects){const s=X.Objects.Material;for(const n in s){const r=this.parseMaterial(s[n],e);r!==null&&t.set(parseInt(n),r)}}return t}parseMaterial(e,t){const s=e.id,n=e.attrName;let r=e.ShadingModel;if(typeof r=="object"&&(r=r.value),!pe.has(s))return null;const i=this.parseParameters(e,t,s);let o;switch(r.toLowerCase()){case"phong":o=new Ze;break;case"lambert":o=new Bn;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),o=new Ze;break}return o.setValues(i),o.name=n,o}parseParameters(e,t,s){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=Ae.colorSpaceToWorking(new ye().fromArray(e.Diffuse.value),ue):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(n.color=Ae.colorSpaceToWorking(new ye().fromArray(e.DiffuseColor.value),ue)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=Ae.colorSpaceToWorking(new ye().fromArray(e.Emissive.value),ue):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(n.emissive=Ae.colorSpaceToWorking(new ye().fromArray(e.EmissiveColor.value),ue)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),n.opacity=1-(e.TransparencyFactor?parseFloat(e.TransparencyFactor.value):0),(n.opacity===1||n.opacity===0)&&(n.opacity=e.Opacity?parseFloat(e.Opacity.value):null,n.opacity===null&&(n.opacity=1-(e.TransparentColor?parseFloat(e.TransparentColor.value[0]):0))),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=Ae.colorSpaceToWorking(new ye().fromArray(e.Specular.value),ue):e.SpecularColor&&e.SpecularColor.type==="Color"&&(n.specular=Ae.colorSpaceToWorking(new ye().fromArray(e.SpecularColor.value),ue));const r=this;return pe.get(s).children.forEach(function(i){const o=i.relationship;switch(o){case"Bump":n.bumpMap=r.getTexture(t,i.ID);break;case"Maya|TEX_ao_map":n.aoMap=r.getTexture(t,i.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=r.getTexture(t,i.ID),n.map!==void 0&&(n.map.colorSpace=ue);break;case"DisplacementColor":n.displacementMap=r.getTexture(t,i.ID);break;case"EmissiveColor":n.emissiveMap=r.getTexture(t,i.ID),n.emissiveMap!==void 0&&(n.emissiveMap.colorSpace=ue);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=r.getTexture(t,i.ID);break;case"ReflectionColor":n.envMap=r.getTexture(t,i.ID),n.envMap!==void 0&&(n.envMap.mapping=ur,n.envMap.colorSpace=ue);break;case"SpecularColor":n.specularMap=r.getTexture(t,i.ID),n.specularMap!==void 0&&(n.specularMap.colorSpace=ue);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=r.getTexture(t,i.ID),n.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",o);break}}),n}getTexture(e,t){return"LayeredTexture"in X.Objects&&t in X.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=pe.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in X.Objects){const s=X.Objects.Deformer;for(const n in s){const r=s[n],i=pe.get(parseInt(n));if(r.attrType==="Skin"){const o=this.parseSkeleton(i,s);o.ID=n,i.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),o.geometryID=i.parents[0].ID,e[n]=o}else if(r.attrType==="BlendShape"){const o={id:n};o.rawTargets=this.parseMorphTargets(i,s),o.id=n,i.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[n]=o}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const s=[];return e.children.forEach(function(n){const r=t[n.ID];if(r.attrType!=="Cluster")return;const i={ID:n.ID,indices:[],weights:[],transformLink:new Z().fromArray(r.TransformLink.a)};"Indexes"in r&&(i.indices=r.Indexes.a,i.weights=r.Weights.a),s.push(i)}),{rawBones:s,bones:[]}}parseMorphTargets(e,t){const s=[];for(let n=0;n<e.children.length;n++){const r=e.children[n],i=t[r.ID],o={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if(i.attrType!=="BlendShapeChannel")return;o.geoID=pe.get(parseInt(r.ID)).children.filter(function(l){return l.relationship===void 0})[0].ID,s.push(o)}return s}parseScene(e,t,s){be=new Xe;const n=this.parseModels(e.skeletons,t,s),r=X.Objects.Model,i=this;n.forEach(function(l){const d=r[l.ID];i.setLookAtProperties(l,d),pe.get(l.ID).parents.forEach(function(h){const y=n.get(h.ID);y!==void 0&&y.add(l)}),l.parent===null&&be.add(l)}),this.bindSkeleton(e.skeletons,t,n),this.addGlobalSceneSettings(),be.traverse(function(l){if(l.userData.transformData){l.parent&&(l.userData.transformData.parentMatrix=l.parent.matrix,l.userData.transformData.parentMatrixWorld=l.parent.matrixWorld);const d=ss(l.userData.transformData);l.applyMatrix4(d),l.updateWorldMatrix()}});const o=new ii().parse();be.children.length===1&&be.children[0].isGroup&&(be.children[0].animations=o,be=be.children[0]),be.animations=o}parseModels(e,t,s){const n=new Map,r=X.Objects.Model;for(const i in r){const o=parseInt(i),l=r[i],d=pe.get(o);let g=this.buildSkeleton(d,e,o,l.attrName);if(!g){switch(l.attrType){case"Camera":g=this.createCamera(d);break;case"Light":g=this.createLight(d);break;case"Mesh":g=this.createMesh(d,t,s);break;case"NurbsCurve":g=this.createCurve(d,t);break;case"LimbNode":case"Root":g=new Et;break;default:g=new Xe;break}g.name=l.attrName?ut.sanitizeNodeName(l.attrName):"",g.userData.originalName=l.attrName,g.ID=o}this.getTransformData(g,l),n.set(o,g)}return n}buildSkeleton(e,t,s,n){let r=null;return e.parents.forEach(function(i){for(const o in t){const l=t[o];l.rawBones.forEach(function(d,g){if(d.ID===i.ID){const h=r;r=new Et,r.matrixWorld.copy(d.transformLink),r.name=n?ut.sanitizeNodeName(n):"",r.userData.originalName=n,r.ID=s,l.bones[g]=r,h!==null&&r.add(h)}})}}),r}createCamera(e){let t,s;if(e.children.forEach(function(n){const r=X.Objects.NodeAttribute[n.ID];r!==void 0&&(s=r)}),s===void 0)t=new Qe;else{let n=0;s.CameraProjectionType!==void 0&&s.CameraProjectionType.value===1&&(n=1);let r=1;s.NearPlane!==void 0&&(r=s.NearPlane.value/1e3);let i=1e3;s.FarPlane!==void 0&&(i=s.FarPlane.value/1e3);let o=window.innerWidth,l=window.innerHeight;s.AspectWidth!==void 0&&s.AspectHeight!==void 0&&(o=s.AspectWidth.value,l=s.AspectHeight.value);const d=o/l;let g=45;s.FieldOfView!==void 0&&(g=s.FieldOfView.value);const h=s.FocalLength?s.FocalLength.value:null;switch(n){case 0:t=new xt(g,d,r,i),h!==null&&t.setFocalLength(h);break;case 1:console.warn("THREE.FBXLoader: Orthographic cameras not supported yet."),t=new Qe;break;default:console.warn("THREE.FBXLoader: Unknown camera type "+n+"."),t=new Qe;break}}return t}createLight(e){let t,s;if(e.children.forEach(function(n){const r=X.Objects.NodeAttribute[n.ID];r!==void 0&&(s=r)}),s===void 0)t=new Qe;else{let n;s.LightType===void 0?n=0:n=s.LightType.value;let r=16777215;s.Color!==void 0&&(r=Ae.colorSpaceToWorking(new ye().fromArray(s.Color.value),ue));let i=s.Intensity===void 0?1:s.Intensity.value/100;s.CastLightOnObject!==void 0&&s.CastLightOnObject.value===0&&(i=0);let o=0;s.FarAttenuationEnd!==void 0&&(s.EnableFarAttenuation!==void 0&&s.EnableFarAttenuation.value===0?o=0:o=s.FarAttenuationEnd.value);const l=1;switch(n){case 0:t=new At(r,i,o,l);break;case 1:t=new Jt(r,i);break;case 2:let d=Math.PI/3;s.InnerAngle!==void 0&&(d=me.degToRad(s.InnerAngle.value));let g=0;s.OuterAngle!==void 0&&(g=me.degToRad(s.OuterAngle.value),g=Math.max(g,1)),t=new Yt(r,i,o,d,g,l);break;default:console.warn("THREE.FBXLoader: Unknown light type "+s.LightType.value+", defaulting to a PointLight."),t=new At(r,i);break}s.CastShadows!==void 0&&s.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,s){let n,r=null,i=null;const o=[];if(e.children.forEach(function(l){t.has(l.ID)&&(r=t.get(l.ID)),s.has(l.ID)&&o.push(s.get(l.ID))}),o.length>1?i=o:o.length>0?i=o[0]:(i=new Ze({name:nt.DEFAULT_MATERIAL_NAME,color:13421772}),o.push(i)),"color"in r.attributes&&o.forEach(function(l){l.vertexColors=!0}),r.groups.length>0){let l=!1;for(let d=0,g=r.groups.length;d<g;d++){const h=r.groups[d];(h.materialIndex<0||h.materialIndex>=o.length)&&(h.materialIndex=o.length,l=!0)}if(l){const d=new Ze;o.push(d)}}return r.FBX_Deformer?(n=new $t(r,i),n.normalizeSkinWeights()):n=new Zt(r,i),n}createCurve(e,t){const s=e.children.reduce(function(r,i){return t.has(i.ID)&&(r=t.get(i.ID)),r},null),n=new vt({name:nt.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new Qt(s,n)}getTransformData(e,t){const s={};"InheritType"in t&&(s.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?s.eulerOrder=ft(t.RotationOrder.value):s.eulerOrder=ft(0),"Lcl_Translation"in t&&(s.translation=t.Lcl_Translation.value),"PreRotation"in t&&(s.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(s.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(s.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(s.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(s.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(s.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(s.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(s.rotationPivot=t.RotationPivot.value),e.userData.transformData=s}setLookAtProperties(e,t){"LookAtProperty"in t&&pe.get(e.ID).children.forEach(function(n){if(n.relationship==="LookAtProperty"){const r=X.Objects.Model[n.ID];if("Lcl_Translation"in r){const i=r.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(i),be.add(e.target)):e.lookAt(new ce().fromArray(i))}}})}bindSkeleton(e,t,s){const n=this.parsePoseNodes();for(const r in e){const i=e[r];pe.get(parseInt(i.ID)).parents.forEach(function(l){if(t.has(l.ID)){const d=l.ID;pe.get(d).parents.forEach(function(h){s.has(h.ID)&&s.get(h.ID).bind(new en(i.bones),n[h.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in X.Objects){const t=X.Objects.Pose;for(const s in t)if(t[s].attrType==="BindPose"&&t[s].NbPoseNodes>0){const n=t[s].PoseNode;Array.isArray(n)?n.forEach(function(r){e[r.Node]=new Z().fromArray(r.Matrix.a)}):e[n.Node]=new Z().fromArray(n.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in X){if("AmbientColor"in X.GlobalSettings){const e=X.GlobalSettings.AmbientColor.value,t=e[0],s=e[1],n=e[2];if(t!==0||s!==0||n!==0){const r=new ye().setRGB(t,s,n,ue);be.add(new Un(r,1))}}"UnitScaleFactor"in X.GlobalSettings&&(be.userData.unitScaleFactor=X.GlobalSettings.UnitScaleFactor.value)}}}class ri{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in X.Objects){const s=X.Objects.Geometry;for(const n in s){const r=pe.get(parseInt(n)),i=this.parseGeometry(r,s[n],e);t.set(parseInt(n),i)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,s){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,s);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,s){const n=s.skeletons,r=[],i=e.parents.map(function(h){return X.Objects.Model[h.ID]});if(i.length===0)return;const o=e.children.reduce(function(h,y){return n[y.ID]!==void 0&&(h=n[y.ID]),h},null);e.children.forEach(function(h){s.morphTargets[h.ID]!==void 0&&r.push(s.morphTargets[h.ID])});const l=i[0],d={};"RotationOrder"in l&&(d.eulerOrder=ft(l.RotationOrder.value)),"InheritType"in l&&(d.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(d.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(d.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(d.scale=l.GeometricScaling.value);const g=ss(d);return this.genGeometry(t,o,r,g)}genGeometry(e,t,s,n){const r=new rt;e.attrName&&(r.name=e.attrName);const i=this.parseGeoNode(e,t),o=this.genBuffers(i),l=new ve(o.vertex,3);if(l.applyMatrix4(n),r.setAttribute("position",l),o.colors.length>0&&r.setAttribute("color",new ve(o.colors,3)),t&&(r.setAttribute("skinIndex",new fr(o.weightsIndices,4)),r.setAttribute("skinWeight",new ve(o.vertexWeights,4)),r.FBX_Deformer=t),o.normal.length>0){const d=new dr().getNormalMatrix(n),g=new ve(o.normal,3);g.applyNormalMatrix(d),r.setAttribute("normal",g)}if(o.uvs.forEach(function(d,g){const h=g===0?"uv":`uv${g}`;r.setAttribute(h,new ve(o.uvs[g],2))}),i.material&&i.material.mappingType!=="AllSame"){let d=o.materialIndex[0],g=0;if(o.materialIndex.forEach(function(h,y){h!==d&&(r.addGroup(g,y-g,d),d=h,g=y)}),r.groups.length>0){const h=r.groups[r.groups.length-1],y=h.start+h.count;y!==o.materialIndex.length&&r.addGroup(y,o.materialIndex.length-y,d)}r.groups.length===0&&r.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(r,e,s,n),r}parseGeoNode(e,t){const s={};if(s.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],s.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&e.LayerElementColor[0].Colors&&(s.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(s.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(s.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){s.uv=[];let n=0;for(;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&s.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return s.weightTable={},t!==null&&(s.skeleton=t,t.rawBones.forEach(function(n,r){n.indices.forEach(function(i,o){s.weightTable[i]===void 0&&(s.weightTable[i]=[]),s.weightTable[i].push({id:r,weight:n.weights[o]})})})),s}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let s=0,n=0,r=!1,i=[],o=[],l=[],d=[],g=[],h=[];const y=this;return e.vertexIndices.forEach(function(T,x){let v,A=!1;T<0&&(T=T^-1,A=!0);let L=[],H=[];if(i.push(T*3,T*3+1,T*3+2),e.color){const R=bt(x,s,T,e.color);l.push(R[0],R[1],R[2])}if(e.skeleton){if(e.weightTable[T]!==void 0&&e.weightTable[T].forEach(function(R){H.push(R.weight),L.push(R.id)}),H.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const R=[0,0,0,0],B=[0,0,0,0];H.forEach(function(J,Q){let ee=J,V=L[Q];B.forEach(function(z,Y,$){if(ee>z){$[Y]=ee,ee=z;const ke=R[Y];R[Y]=V,V=ke}})}),L=R,H=B}for(;H.length<4;)H.push(0),L.push(0);for(let R=0;R<4;++R)g.push(H[R]),h.push(L[R])}if(e.normal){const R=bt(x,s,T,e.normal);o.push(R[0],R[1],R[2])}e.material&&e.material.mappingType!=="AllSame"&&(v=bt(x,s,T,e.material)[0],v<0&&(y.negativeMaterialIndices=!0,v=0)),e.uv&&e.uv.forEach(function(R,B){const J=bt(x,s,T,R);d[B]===void 0&&(d[B]=[]),d[B].push(J[0]),d[B].push(J[1])}),n++,A&&(y.genFace(t,e,i,v,o,l,d,g,h,n),s++,n=0,i=[],o=[],l=[],d=[],g=[],h=[])}),t}getNormalNewell(e){const t=new ce(0,0,0);for(let s=0;s<e.length;s++){const n=e[s],r=e[(s+1)%e.length];t.x+=(n.y-r.y)*(n.z+r.z),t.y+=(n.z-r.z)*(n.x+r.x),t.z+=(n.x-r.x)*(n.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),n=(Math.abs(t.z)>.5?new ce(0,1,0):new ce(0,0,1)).cross(t).normalize(),r=t.clone().cross(n).normalize();return{normal:t,tangent:n,bitangent:r}}flattenVertex(e,t,s){return new Lt(e.dot(t),e.dot(s))}genFace(e,t,s,n,r,i,o,l,d,g){let h;if(g>3){const y=[],T=t.baseVertexPositions||t.vertexPositions;for(let L=0;L<s.length;L+=3)y.push(new ce(T[s[L]],T[s[L+1]],T[s[L+2]]));const{tangent:x,bitangent:v}=this.getNormalTangentAndBitangent(y),A=[];for(const L of y)A.push(this.flattenVertex(L,x,v));h=hr.triangulateShape(A,[])}else h=[[0,1,2]];for(const[y,T,x]of h)e.vertex.push(t.vertexPositions[s[y*3]]),e.vertex.push(t.vertexPositions[s[y*3+1]]),e.vertex.push(t.vertexPositions[s[y*3+2]]),e.vertex.push(t.vertexPositions[s[T*3]]),e.vertex.push(t.vertexPositions[s[T*3+1]]),e.vertex.push(t.vertexPositions[s[T*3+2]]),e.vertex.push(t.vertexPositions[s[x*3]]),e.vertex.push(t.vertexPositions[s[x*3+1]]),e.vertex.push(t.vertexPositions[s[x*3+2]]),t.skeleton&&(e.vertexWeights.push(l[y*4]),e.vertexWeights.push(l[y*4+1]),e.vertexWeights.push(l[y*4+2]),e.vertexWeights.push(l[y*4+3]),e.vertexWeights.push(l[T*4]),e.vertexWeights.push(l[T*4+1]),e.vertexWeights.push(l[T*4+2]),e.vertexWeights.push(l[T*4+3]),e.vertexWeights.push(l[x*4]),e.vertexWeights.push(l[x*4+1]),e.vertexWeights.push(l[x*4+2]),e.vertexWeights.push(l[x*4+3]),e.weightsIndices.push(d[y*4]),e.weightsIndices.push(d[y*4+1]),e.weightsIndices.push(d[y*4+2]),e.weightsIndices.push(d[y*4+3]),e.weightsIndices.push(d[T*4]),e.weightsIndices.push(d[T*4+1]),e.weightsIndices.push(d[T*4+2]),e.weightsIndices.push(d[T*4+3]),e.weightsIndices.push(d[x*4]),e.weightsIndices.push(d[x*4+1]),e.weightsIndices.push(d[x*4+2]),e.weightsIndices.push(d[x*4+3])),t.color&&(e.colors.push(i[y*3]),e.colors.push(i[y*3+1]),e.colors.push(i[y*3+2]),e.colors.push(i[T*3]),e.colors.push(i[T*3+1]),e.colors.push(i[T*3+2]),e.colors.push(i[x*3]),e.colors.push(i[x*3+1]),e.colors.push(i[x*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(r[y*3]),e.normal.push(r[y*3+1]),e.normal.push(r[y*3+2]),e.normal.push(r[T*3]),e.normal.push(r[T*3+1]),e.normal.push(r[T*3+2]),e.normal.push(r[x*3]),e.normal.push(r[x*3+1]),e.normal.push(r[x*3+2])),t.uv&&t.uv.forEach(function(v,A){e.uvs[A]===void 0&&(e.uvs[A]=[]),e.uvs[A].push(o[A][y*2]),e.uvs[A].push(o[A][y*2+1]),e.uvs[A].push(o[A][T*2]),e.uvs[A].push(o[A][T*2+1]),e.uvs[A].push(o[A][x*2]),e.uvs[A].push(o[A][x*2+1])})}addMorphTargets(e,t,s,n){if(s.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;s.forEach(function(i){i.rawTargets.forEach(function(o){const l=X.Objects.Geometry[o.geoID];l!==void 0&&r.genMorphGeometry(e,t,l,n,o.name)})})}genMorphGeometry(e,t,s,n,r){const i=t.Vertices!==void 0?t.Vertices.a:[],o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],l=s.Vertices!==void 0?s.Vertices.a:[],d=s.Indexes!==void 0?s.Indexes.a:[],g=e.attributes.position.count*3,h=new Float32Array(g);for(let v=0;v<d.length;v++){const A=d[v]*3;h[A]=l[v*3],h[A+1]=l[v*3+1],h[A+2]=l[v*3+2]}const y={vertexIndices:o,vertexPositions:h,baseVertexPositions:i},T=this.genBuffers(y),x=new ve(T.vertex,3);x.name=r||s.attrName,x.applyMatrix4(n),e.morphAttributes.position.push(x)}parseNormals(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.Normals.a;let r=[];return s==="IndexToDirect"&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:r,mappingType:t,referenceType:s}}parseUVs(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.UV.a;let r=[];return s==="IndexToDirect"&&(r=e.UVIndex.a),{dataSize:2,buffer:n,indices:r,mappingType:t,referenceType:s}}parseVertexColors(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,n=e.Colors.a;let r=[];s==="IndexToDirect"&&(r=e.ColorIndex.a);for(let i=0,o=new ye;i<n.length;i+=4)o.fromArray(n,i),Ae.colorSpaceToWorking(o,ue),o.toArray(n,i);return{dataSize:4,buffer:n,indices:r,mappingType:t,referenceType:s}}parseMaterialIndices(e){const t=e.MappingInformationType,s=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:s};const n=e.Materials.a,r=[];for(let i=0;i<n.length;++i)r.push(i);return{dataSize:1,buffer:n,indices:r,mappingType:t,referenceType:s}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new rt;const s=t-1,n=e.KnotVector.a,r=[],i=e.Points.a;for(let h=0,y=i.length;h<y;h+=4)r.push(new lt().fromArray(i,h));let o,l;if(e.Form==="Closed")r.push(r[0]);else if(e.Form==="Periodic"){o=s,l=n.length-1-o;for(let h=0;h<s;++h)r.push(r[h])}const g=new ti(s,n,r,o,l).getPoints(r.length*12);return new rt().setFromPoints(g)}}class ii{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const s in t){const n=t[s],r=this.addClip(n);e.push(r)}return e}parseClips(){if(X.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=X.Objects.AnimationCurveNode,t=new Map;for(const s in e){const n=e[s];if(n.attrName.match(/S|R|T|DeformPercent/)!==null){const r={id:n.id,attr:n.attrName,curves:{}};t.set(r.id,r)}}return t}parseAnimationCurves(e){const t=X.Objects.AnimationCurve;for(const s in t){const n={id:t[s].id,times:t[s].KeyTime.a.map(ui),values:t[s].KeyValueFloat.a},r=pe.get(n.id);if(r!==void 0){const i=r.parents[0].ID,o=r.parents[0].relationship;o.match(/X/)?e.get(i).curves.x=n:o.match(/Y/)?e.get(i).curves.y=n:o.match(/Z/)?e.get(i).curves.z=n:o.match(/DeformPercent/)&&e.has(i)&&(e.get(i).curves.morph=n)}}}parseAnimationLayers(e){const t=X.Objects.AnimationLayer,s=new Map;for(const n in t){const r=[],i=pe.get(parseInt(n));i!==void 0&&(i.children.forEach(function(l,d){if(e.has(l.ID)){const g=e.get(l.ID);if(g.curves.x!==void 0||g.curves.y!==void 0||g.curves.z!==void 0){if(r[d]===void 0){const h=pe.get(l.ID).parents.filter(function(y){return y.relationship!==void 0})[0].ID;if(h!==void 0){const y=X.Objects.Model[h.toString()];if(y===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",l);return}const T={modelName:y.attrName?ut.sanitizeNodeName(y.attrName):"",ID:y.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};be.traverse(function(x){x.ID===y.id&&(T.transform=x.matrix,x.userData.transformData&&(T.eulerOrder=x.userData.transformData.eulerOrder))}),T.transform||(T.transform=new Z),"PreRotation"in y&&(T.preRotation=y.PreRotation.value),"PostRotation"in y&&(T.postRotation=y.PostRotation.value),r[d]=T}}r[d]&&(r[d][g.attr]=g)}else if(g.curves.morph!==void 0){if(r[d]===void 0){const h=pe.get(l.ID).parents.filter(function(L){return L.relationship!==void 0})[0].ID,y=pe.get(h).parents[0].ID,T=pe.get(y).parents[0].ID,x=pe.get(T).parents[0].ID,v=X.Objects.Model[x],A={modelName:v.attrName?ut.sanitizeNodeName(v.attrName):"",morphName:X.Objects.Deformer[h].attrName};r[d]=A}r[d][g.attr]=g}}}),s.set(parseInt(n),r))}return s}parseAnimStacks(e){const t=X.Objects.AnimationStack,s={};for(const n in t){const r=pe.get(parseInt(n)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const i=e.get(r[0].ID);s[n]={name:t[n].attrName,layer:i}}return s}addClip(e){let t=[];const s=this;return e.layer.forEach(function(n){t=t.concat(s.generateTracks(n))}),new wt(e.name,-1,t)}generateTracks(e){const t=[];let s=new ce,n=new ce;if(e.transform&&e.transform.decompose(s,new Me,n),s=s.toArray(),n=n.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,s,"position");r!==void 0&&t.push(r)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const r=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);r!==void 0&&t.push(r)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.S.curves,n,"scale");r!==void 0&&t.push(r)}if(e.DeformPercent!==void 0){const r=this.generateMorphTrack(e);r!==void 0&&t.push(r)}return t}generateVectorTrack(e,t,s,n){const r=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(r,t,s);return new ot(e+"."+n,r,i)}generateRotationTrack(e,t,s,n,r){let i,o;if(t.x!==void 0&&t.y!==void 0&&t.z!==void 0){const y=this.interpolateRotations(t.x,t.y,t.z,r);i=y[0],o=y[1]}const l=ft(0);s!==void 0&&(s=s.map(me.degToRad),s.push(l),s=new Ve().fromArray(s),s=new Me().setFromEuler(s)),n!==void 0&&(n=n.map(me.degToRad),n.push(l),n=new Ve().fromArray(n),n=new Me().setFromEuler(n).invert());const d=new Me,g=new Ve,h=[];if(!o||!i)return new at(e+".quaternion",[0],[0]);for(let y=0;y<o.length;y+=3)g.set(o[y],o[y+1],o[y+2],r),d.setFromEuler(g),s!==void 0&&d.premultiply(s),n!==void 0&&d.multiply(n),y>2&&new Me().fromArray(h,(y-3)/3*4).dot(d)<0&&d.set(-d.x,-d.y,-d.z,-d.w),d.toArray(h,y/3*4);return new at(e+".quaternion",i,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,s=t.values.map(function(r){return r/100}),n=be.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Vt(e.modelName+".morphTargetInfluences["+n+"]",t.times,s)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(s,n){return s-n}),t.length>1){let s=1,n=t[0];for(let r=1;r<t.length;r++){const i=t[r];i!==n&&(t[s]=i,n=i,s++)}t=t.slice(0,s)}return t}getKeyframeTrackValues(e,t,s){const n=s,r=[];let i=-1,o=-1,l=-1;return e.forEach(function(d){if(t.x&&(i=t.x.times.indexOf(d)),t.y&&(o=t.y.times.indexOf(d)),t.z&&(l=t.z.times.indexOf(d)),i!==-1){const g=t.x.values[i];r.push(g),n[0]=g}else r.push(n[0]);if(o!==-1){const g=t.y.values[o];r.push(g),n[1]=g}else r.push(n[1]);if(l!==-1){const g=t.z.values[l];r.push(g),n[2]=g}else r.push(n[2])}),r}interpolateRotations(e,t,s,n){const r=[],i=[];r.push(e.times[0]),i.push(me.degToRad(e.values[0])),i.push(me.degToRad(t.values[0])),i.push(me.degToRad(s.values[0]));for(let o=1;o<e.values.length;o++){const l=[e.values[o-1],t.values[o-1],s.values[o-1]];if(isNaN(l[0])||isNaN(l[1])||isNaN(l[2]))continue;const d=l.map(me.degToRad),g=[e.values[o],t.values[o],s.values[o]];if(isNaN(g[0])||isNaN(g[1])||isNaN(g[2]))continue;const h=g.map(me.degToRad),y=[g[0]-l[0],g[1]-l[1],g[2]-l[2]],T=[Math.abs(y[0]),Math.abs(y[1]),Math.abs(y[2])];if(T[0]>=180||T[1]>=180||T[2]>=180){const v=Math.max(...T)/180,A=new Ve(...d,n),L=new Ve(...h,n),H=new Me().setFromEuler(A),R=new Me().setFromEuler(L);H.dot(R)&&R.set(-R.x,-R.y,-R.z,-R.w);const B=e.times[o-1],J=e.times[o]-B,Q=new Me,ee=new Ve;for(let V=0;V<1;V+=1/v)Q.copy(H.clone().slerp(R.clone(),V)),r.push(B+V*J),ee.setFromQuaternion(Q,n),i.push(ee.x),i.push(ee.y),i.push(ee.z)}else r.push(e.times[o]),i.push(me.degToRad(e.values[o])),i.push(me.degToRad(t.values[o])),i.push(me.degToRad(s.values[o]))}return[r,i]}}class oi{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new ns,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,s=e.split(/[\r\n]+/);return s.forEach(function(n,r){const i=n.match(/^[\s\t]*;/),o=n.match(/^[\s\t]*$/);if(i||o)return;const l=n.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),d=n.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),g=n.match("^\\t{"+(t.currentIndent-1)+"}}");l?t.parseNodeBegin(n,l):d?t.parseNodeProperty(n,d,s[++r]):g?t.popStack():n.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(n)}),this.allNodes}parseNodeBegin(e,t){const s=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(l){return l.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:s},i=this.parseNodeAttr(n),o=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(s,r):s in o?(s==="PoseNode"?o.PoseNode.push(r):o[s].id!==void 0&&(o[s]={},o[s][o[s].id]=o[s]),i.id!==""&&(o[s][i.id]=r)):typeof i.id=="number"?(o[s]={},o[s][i.id]=r):s!=="Properties70"&&(s==="PoseNode"?o[s]=[r]:o[s]=r),typeof i.id=="number"&&(r.id=i.id),i.name!==""&&(r.attrName=i.name),i.type!==""&&(r.attrType=i.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let s="",n="";return e.length>1&&(s=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:s,type:n}}parseNodeProperty(e,t,s){let n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();n==="Content"&&r===","&&(r=s.replace(/"/g,"").replace(/,$/,"").trim());const i=this.getCurrentNode();if(i.name==="Properties70"){this.parseNodeSpecialProperty(e,n,r);return}if(n==="C"){const l=r.split(",").slice(1),d=parseInt(l[0]),g=parseInt(l[1]);let h=r.split(",").slice(3);h=h.map(function(y){return y.trim().replace(/^"/,"")}),n="connections",r=[d,g],di(r,h),i[n]===void 0&&(i[n]=[])}n==="Node"&&(i.id=r),n in i&&Array.isArray(i[n])?i[n].push(r):n!=="a"?i[n]=r:i.a=r,this.setCurrentProp(i,n),n==="a"&&r.slice(-1)!==","&&(i.a=Bt(r))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Bt(t.a))}parseNodeSpecialProperty(e,t,s){const n=s.split('",').map(function(g){return g.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=n[0],i=n[1],o=n[2],l=n[3];let d=n[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":d=parseFloat(d);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":d=Bt(d);break}this.getPrevNode()[r]={type:i,type2:o,flag:l,value:d},this.setCurrentProp(this.getPrevNode(),r)}}class ai{parse(e){const t=new Mn(e);t.skip(23);const s=t.getUint32();if(s<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+s);const n=new ns;for(;!this.endOfContent(t);){const r=this.parseNode(t,s);r!==null&&n.add(r.name,r)}return n}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const s={},n=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const i=e.getUint8(),o=e.getString(i);if(n===0)return null;const l=[];for(let y=0;y<r;y++)l.push(this.parseProperty(e));const d=l.length>0?l[0]:"",g=l.length>1?l[1]:"",h=l.length>2?l[2]:"";for(s.singleProperty=r===1&&e.getOffset()===n;n>e.getOffset();){const y=this.parseNode(e,t);y!==null&&this.parseSubNode(o,s,y)}return s.propertyList=l,typeof d=="number"&&(s.id=d),g!==""&&(s.attrName=g),h!==""&&(s.attrType=h),o!==""&&(s.name=o),s}parseSubNode(e,t,s){if(s.singleProperty===!0){const n=s.propertyList[0];Array.isArray(n)?(t[s.name]=s,s.a=n):t[s.name]=n}else if(e==="Connections"&&s.name==="C"){const n=[];s.propertyList.forEach(function(r,i){i!==0&&n.push(r)}),t.connections===void 0&&(t.connections=[]),t.connections.push(n)}else if(s.name==="Properties70")Object.keys(s).forEach(function(r){t[r]=s[r]});else if(e==="Properties70"&&s.name==="P"){let n=s.propertyList[0],r=s.propertyList[1];const i=s.propertyList[2],o=s.propertyList[3];let l;n.indexOf("Lcl ")===0&&(n=n.replace("Lcl ","Lcl_")),r.indexOf("Lcl ")===0&&(r=r.replace("Lcl ","Lcl_")),r==="Color"||r==="ColorRGB"||r==="Vector"||r==="Vector3D"||r.indexOf("Lcl_")===0?l=[s.propertyList[4],s.propertyList[5],s.propertyList[6]]:l=s.propertyList[4],t[n]={type:r,type2:i,flag:o,value:l}}else t[s.name]===void 0?typeof s.id=="number"?(t[s.name]={},t[s.name][s.id]=s):t[s.name]=s:s.name==="PoseNode"?(Array.isArray(t[s.name])||(t[s.name]=[t[s.name]]),t[s.name].push(s)):t[s.name][s.id]===void 0&&(t[s.name][s.id]=s)}parseProperty(e){const t=e.getString(1);let s;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return s=e.getUint32(),e.getArrayBuffer(s);case"S":return s=e.getUint32(),e.getString(s);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=e.getUint32(),r=e.getUint32(),i=e.getUint32();if(r===0)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}const o=zr(new Uint8Array(e.getArrayBuffer(i))),l=new Mn(o.buffer);switch(t){case"b":case"c":return l.getBooleanArray(n);case"d":return l.getFloat64Array(n);case"f":return l.getFloat32Array(n);case"i":return l.getInt32Array(n);case"l":return l.getInt64Array(n)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Mn{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let s=0;s<e;s++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let s=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const n=s.indexOf(0);return n>=0&&(s=new Uint8Array(this.dv.buffer,t,n)),this._textDecoder.decode(s)}}class ns{add(e,t){this[e]=t}}function ci(m){const e="Kaydara FBX Binary  \0";return m.byteLength>=e.length&&e===rs(m,0,e.length)}function li(m){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function s(n){const r=m[n-1];return m=m.slice(t+n),t++,r}for(let n=0;n<e.length;++n)if(s(1)===e[n])return!1;return!0}function Nn(m){const e=/FBXVersion: (\d+)/,t=m.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function ui(m){return m/46186158e3}const fi=[];function bt(m,e,t,s){let n;switch(s.mappingType){case"ByPolygonVertex":n=m;break;case"ByPolygon":n=e;break;case"ByVertice":n=t;break;case"AllSame":n=s.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+s.mappingType)}s.referenceType==="IndexToDirect"&&(n=s.indices[n]);const r=n*s.dataSize,i=r+s.dataSize;return hi(fi,s.buffer,r,i)}const Dt=new Ve,$e=new ce;function ss(m){const e=new Z,t=new Z,s=new Z,n=new Z,r=new Z,i=new Z,o=new Z,l=new Z,d=new Z,g=new Z,h=new Z,y=new Z,T=m.inheritType?m.inheritType:0;m.translation&&e.setPosition($e.fromArray(m.translation));const x=ft(0);if(m.preRotation){const $=m.preRotation.map(me.degToRad);$.push(x),t.makeRotationFromEuler(Dt.fromArray($))}if(m.rotation){const $=m.rotation.map(me.degToRad);$.push(m.eulerOrder||x),s.makeRotationFromEuler(Dt.fromArray($))}if(m.postRotation){const $=m.postRotation.map(me.degToRad);$.push(x),n.makeRotationFromEuler(Dt.fromArray($)),n.invert()}m.scale&&r.scale($e.fromArray(m.scale)),m.scalingOffset&&o.setPosition($e.fromArray(m.scalingOffset)),m.scalingPivot&&i.setPosition($e.fromArray(m.scalingPivot)),m.rotationOffset&&l.setPosition($e.fromArray(m.rotationOffset)),m.rotationPivot&&d.setPosition($e.fromArray(m.rotationPivot)),m.parentMatrixWorld&&(h.copy(m.parentMatrix),g.copy(m.parentMatrixWorld));const v=t.clone().multiply(s).multiply(n),A=new Z;A.extractRotation(g);const L=new Z;L.copyPosition(g);const H=L.clone().invert().multiply(g),R=A.clone().invert().multiply(H),B=r,J=new Z;if(T===0)J.copy(A).multiply(v).multiply(R).multiply(B);else if(T===1)J.copy(A).multiply(R).multiply(v).multiply(B);else{const ke=new Z().scale(new ce().setFromMatrixScale(h)).clone().invert(),Fe=R.clone().multiply(ke);J.copy(A).multiply(v).multiply(Fe).multiply(B)}const Q=d.clone().invert(),ee=i.clone().invert();let V=e.clone().multiply(l).multiply(d).multiply(t).multiply(s).multiply(n).multiply(Q).multiply(o).multiply(i).multiply(r).multiply(ee);const z=new Z().copyPosition(V),Y=g.clone().multiply(z);return y.copyPosition(Y),V=y.clone().multiply(J),V.premultiply(g.invert()),V}function ft(m){m=m||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return m===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[m]}function Bt(m){return m.split(",").map(function(t){return parseFloat(t)})}function rs(m,e,t){return e===void 0&&(e=0),t===void 0&&(t=m.byteLength),new TextDecoder().decode(new Uint8Array(m,e,t))}function di(m,e){for(let t=0,s=m.length,n=e.length;t<n;t++,s++)m[s]=e[t]}function hi(m,e,t,s){for(let n=t,r=0;n<s;n++,r++)m[r]=e[n];return m}function Sn(m,e){if(e===pr)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),m;if(e===Kt||e===Kn){let t=m.getIndex();if(t===null){const i=[],o=m.getAttribute("position");if(o!==void 0){for(let l=0;l<o.count;l++)i.push(l);m.setIndex(i),t=m.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),m}const s=t.count-2,n=[];if(e===Kt)for(let i=1;i<=s;i++)n.push(t.getX(0)),n.push(t.getX(i)),n.push(t.getX(i+1));else for(let i=0;i<s;i++)i%2===0?(n.push(t.getX(i)),n.push(t.getX(i+1)),n.push(t.getX(i+2))):(n.push(t.getX(i+2)),n.push(t.getX(i+1)),n.push(t.getX(i)));n.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=m.clone();return r.setIndex(n),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),m}class pi extends nt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new bi(t)}),this.register(function(t){return new wi(t)}),this.register(function(t){return new _i(t)}),this.register(function(t){return new Mi(t)}),this.register(function(t){return new Ni(t)}),this.register(function(t){return new Ai(t)}),this.register(function(t){return new Ei(t)}),this.register(function(t){return new vi(t)}),this.register(function(t){return new ki(t)}),this.register(function(t){return new Ti(t)}),this.register(function(t){return new Ri(t)}),this.register(function(t){return new xi(t)}),this.register(function(t){return new Li(t)}),this.register(function(t){return new Ii(t)}),this.register(function(t){return new gi(t)}),this.register(function(t){return new Si(t)}),this.register(function(t){return new Ci(t)})}load(e,t,s,n){const r=this;let i;if(this.resourcePath!=="")i=this.resourcePath;else if(this.path!==""){const d=ze.extractUrlBase(e);i=ze.resolveURL(d,this.path)}else i=ze.extractUrlBase(e);this.manager.itemStart(e);const o=function(d){n?n(d):console.error(d),r.manager.itemError(e),r.manager.itemEnd(e)},l=new It(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(d){try{r.parse(d,i,function(g){t(g),r.manager.itemEnd(e)},o)}catch(g){o(g)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const i={},o={},l=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(l.decode(new Uint8Array(e,0,4))===is){try{i[W.KHR_BINARY_GLTF]=new Fi(e)}catch(h){n&&n(h);return}r=JSON.parse(i[W.KHR_BINARY_GLTF].content)}else r=JSON.parse(l.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const d=new qi(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});d.fileLoader.setRequestHeader(this.requestHeader);for(let g=0;g<this.pluginCallbacks.length;g++){const h=this.pluginCallbacks[g](d);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[h.name]=h,i[h.name]=!0}if(r.extensionsUsed)for(let g=0;g<r.extensionsUsed.length;++g){const h=r.extensionsUsed[g],y=r.extensionsRequired||[];switch(h){case W.KHR_MATERIALS_UNLIT:i[h]=new yi;break;case W.KHR_DRACO_MESH_COMPRESSION:i[h]=new Pi(r,this.dracoLoader);break;case W.KHR_TEXTURE_TRANSFORM:i[h]=new Oi;break;case W.KHR_MESH_QUANTIZATION:i[h]=new Di;break;default:y.indexOf(h)>=0&&o[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}d.setExtensions(i),d.setPlugins(o),d.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function mi(){let m={};return{get:function(e){return m[e]},add:function(e,t){m[e]=t},remove:function(e){delete m[e]},removeAll:function(){m={}}}}const W={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class gi{constructor(e){this.parser=e,this.name=W.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,l=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let d;const g=new ye(16777215);l.color!==void 0&&g.setRGB(l.color[0],l.color[1],l.color[2],De);const h=l.range!==void 0?l.range:0;switch(l.type){case"directional":d=new Jt(g),d.target.position.set(0,0,-1),d.add(d.target);break;case"point":d=new At(g),d.distance=h;break;case"spot":d=new Yt(g),d.distance=h,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,d.angle=l.spot.outerConeAngle,d.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,d.target.position.set(0,0,-1),d.add(d.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return d.position.set(0,0,0),Se(d,l),l.intensity!==void 0&&(d.intensity=l.intensity),d.name=t.createUniqueName(l.name||"light_"+e),n=Promise.resolve(d),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],o=(r.extensions&&r.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(l){return s._getNodeRef(t.cache,o,l)})}}class yi{constructor(){this.name=W.KHR_MATERIALS_UNLIT}getMaterialType(){return Ke}extendParams(e,t,s){const n=[];e.color=new ye(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const i=r.baseColorFactor;e.color.setRGB(i[0],i[1],i[2],De),e.opacity=i[3]}r.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",r.baseColorTexture,ue))}return Promise.all(n)}}class Ti{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class bi{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];if(i.clearcoatFactor!==void 0&&(t.clearcoat=i.clearcoatFactor),i.clearcoatTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),i.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),i.clearcoatRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),i.clearcoatNormalTexture!==void 0&&(r.push(s.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),i.clearcoatNormalTexture.scale!==void 0)){const o=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Lt(o,o)}return Promise.all(r)}}class wi{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class xi{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.iridescenceFactor!==void 0&&(t.iridescence=i.iridescenceFactor),i.iridescenceTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),i.iridescenceIor!==void 0&&(t.iridescenceIOR=i.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),i.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),i.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),i.iridescenceThicknessTexture!==void 0&&r.push(s.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class Ai{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new ye(0,0,0),t.sheenRoughness=0,t.sheen=1;const i=n.extensions[this.name];if(i.sheenColorFactor!==void 0){const o=i.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],De)}return i.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=i.sheenRoughnessFactor),i.sheenColorTexture!==void 0&&r.push(s.assignTexture(t,"sheenColorMap",i.sheenColorTexture,ue)),i.sheenRoughnessTexture!==void 0&&r.push(s.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class Ei{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.transmissionFactor!==void 0&&(t.transmission=i.transmissionFactor),i.transmissionTexture!==void 0&&r.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class vi{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.thickness=i.thicknessFactor!==void 0?i.thicknessFactor:0,i.thicknessTexture!==void 0&&r.push(s.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;const o=i.attenuationColor||[1,1,1];return t.attenuationColor=new ye().setRGB(o[0],o[1],o[2],De),Promise.all(r)}}class ki{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class Ri{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.specularIntensity=i.specularFactor!==void 0?i.specularFactor:1,i.specularTexture!==void 0&&r.push(s.assignTexture(t,"specularIntensityMap",i.specularTexture));const o=i.specularColorFactor||[1,1,1];return t.specularColor=new ye().setRGB(o[0],o[1],o[2],De),i.specularColorTexture!==void 0&&r.push(s.assignTexture(t,"specularColorMap",i.specularColorTexture,ue)),Promise.all(r)}}class Ii{constructor(e){this.parser=e,this.name=W.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return t.bumpScale=i.bumpFactor!==void 0?i.bumpFactor:1,i.bumpTexture!==void 0&&r.push(s.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(r)}}class Li{constructor(e){this.parser=e,this.name=W.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:Ce}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return i.anisotropyStrength!==void 0&&(t.anisotropy=i.anisotropyStrength),i.anisotropyRotation!==void 0&&(t.anisotropyRotation=i.anisotropyRotation),i.anisotropyTexture!==void 0&&r.push(s.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(r)}}class _i{constructor(e){this.parser=e,this.name=W.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,i)}}class Mi{constructor(e){this.parser=e,this.name=W.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let l=s.textureLoader;if(o.uri){const d=s.options.manager.getHandler(o.uri);d!==null&&(l=d)}return s.loadTextureImage(e,i.source,l)}}class Ni{constructor(e){this.parser=e,this.name=W.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let l=s.textureLoader;if(o.uri){const d=s.options.manager.getHandler(o.uri);d!==null&&(l=d)}return s.loadTextureImage(e,i.source,l)}}class Si{constructor(e){this.name=W.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(o){const l=n.byteOffset||0,d=n.byteLength||0,g=n.count,h=n.byteStride,y=new Uint8Array(o,l,d);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(g,h,y,n.mode,n.filter).then(function(T){return T.buffer}):i.ready.then(function(){const T=new ArrayBuffer(g*h);return i.decodeGltfBuffer(new Uint8Array(T),g,h,y,n.mode,n.filter),T})})}else return null}}class Ci{constructor(e){this.name=W.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const d of n.primitives)if(d.mode!==Re.TRIANGLES&&d.mode!==Re.TRIANGLE_STRIP&&d.mode!==Re.TRIANGLE_FAN&&d.mode!==void 0)return null;const i=s.extensions[this.name].attributes,o=[],l={};for(const d in i)o.push(this.parser.getDependency("accessor",i[d]).then(g=>(l[d]=g,l[d])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(d=>{const g=d.pop(),h=g.isGroup?g.children:[g],y=d[0].count,T=[];for(const x of h){const v=new Z,A=new ce,L=new Me,H=new ce(1,1,1),R=new mr(x.geometry,x.material,y);for(let B=0;B<y;B++)l.TRANSLATION&&A.fromBufferAttribute(l.TRANSLATION,B),l.ROTATION&&L.fromBufferAttribute(l.ROTATION,B),l.SCALE&&H.fromBufferAttribute(l.SCALE,B),R.setMatrixAt(B,v.compose(A,L,H));for(const B in l)if(B==="_COLOR_0"){const J=l[B];R.instanceColor=new gr(J.array,J.itemSize,J.normalized)}else B!=="TRANSLATION"&&B!=="ROTATION"&&B!=="SCALE"&&x.geometry.setAttribute(B,l[B]);Qe.prototype.copy.call(R,x),this.parser.assignFinalMaterial(R),T.push(R)}return g.isGroup?(g.clear(),g.add(...T),g):T[0]}))}}const is="glTF",st=12,Cn={JSON:1313821514,BIN:5130562};class Fi{constructor(e){this.name=W.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,st),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==is)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-st,r=new DataView(e,st);let i=0;for(;i<n;){const o=r.getUint32(i,!0);i+=4;const l=r.getUint32(i,!0);if(i+=4,l===Cn.JSON){const d=new Uint8Array(e,st+i,o);this.content=s.decode(d)}else if(l===Cn.BIN){const d=st+i;this.body=e.slice(d,d+o)}i+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Pi{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=W.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,o={},l={},d={};for(const g in i){const h=Xt[g]||g.toLowerCase();o[h]=i[g]}for(const g in e.attributes){const h=Xt[g]||g.toLowerCase();if(i[g]!==void 0){const y=s.accessors[e.attributes[g]],T=tt[y.componentType];d[h]=T.name,l[h]=y.normalized===!0}}return t.getDependency("bufferView",r).then(function(g){return new Promise(function(h,y){n.decodeDracoFile(g,function(T){for(const x in T.attributes){const v=T.attributes[x],A=l[x];A!==void 0&&(v.normalized=A)}h(T)},o,d,De,y)})})}}class Oi{constructor(){this.name=W.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Di{constructor(){this.name=W.KHR_MESH_QUANTIZATION}}class os extends Lr{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let i=0;i!==n;i++)t[i]=s[r+i];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,i=this.sampleValues,o=this.valueSize,l=o*2,d=o*3,g=n-t,h=(s-t)/g,y=h*h,T=y*h,x=e*d,v=x-d,A=-2*T+3*y,L=T-y,H=1-A,R=L-y+h;for(let B=0;B!==o;B++){const J=i[v+B+o],Q=i[v+B+l]*g,ee=i[x+B+o],V=i[x+B]*g;r[B]=H*J+R*Q+A*ee+L*V}return r}}const Bi=new Me;class Gi extends os{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return Bi.fromArray(r).normalize().toArray(r),r}}const Re={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},tt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Fn={9728:zn,9729:kt,9984:xr,9985:wr,9986:br,9987:Rt},Pn={33071:ct,33648:Ar,10497:Oe},Gt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},He={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Hi={CUBICSPLINE:void 0,LINEAR:qn,STEP:Rr},Ht={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function ji(m){return m.DefaultMaterial===void 0&&(m.DefaultMaterial=new Xn({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Hn})),m.DefaultMaterial}function Ue(m,e,t){for(const s in t.extensions)m[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function Se(m,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(m.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Ui(m,e,t){let s=!1,n=!1,r=!1;for(let d=0,g=e.length;d<g;d++){const h=e[d];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(r=!0),s&&n&&r)break}if(!s&&!n&&!r)return Promise.resolve(m);const i=[],o=[],l=[];for(let d=0,g=e.length;d<g;d++){const h=e[d];if(s){const y=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):m.attributes.position;i.push(y)}if(n){const y=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):m.attributes.normal;o.push(y)}if(r){const y=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):m.attributes.color;l.push(y)}}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(l)]).then(function(d){const g=d[0],h=d[1],y=d[2];return s&&(m.morphAttributes.position=g),n&&(m.morphAttributes.normal=h),r&&(m.morphAttributes.color=y),m.morphTargetsRelative=!0,m})}function Vi(m,e){if(m.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)m.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(m.morphTargetInfluences.length===t.length){m.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)m.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ki(m){let e;const t=m.extensions&&m.extensions[W.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+jt(t.attributes):e=m.indices+":"+jt(m.attributes)+":"+m.mode,m.targets!==void 0)for(let s=0,n=m.targets.length;s<n;s++)e+=":"+jt(m.targets[s]);return e}function jt(m){let e="";const t=Object.keys(m).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+m[t[s]]+";";return e}function qt(m){switch(m){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function zi(m){return m.search(/\.jpe?g($|\?)/i)>0||m.search(/^data\:image\/jpeg/)===0?"image/jpeg":m.search(/\.webp($|\?)/i)>0||m.search(/^data\:image\/webp/)===0?"image/webp":m.search(/\.ktx2($|\?)/i)>0||m.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Xi=new Z;class qi{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new mi,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,r=!1,i=-1;if(typeof navigator<"u"){const o=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(o)===!0;const l=o.match(/Version\/(\d+)/);n=s&&l?parseInt(l[1],10):-1,r=o.indexOf("Firefox")>-1,i=r?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&n<17||r&&i<98?this.textureLoader=new Wt(this.options.manager):this.textureLoader=new yr(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new It(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(i){return i._markDefs&&i._markDefs()}),Promise.all(this._invokeAll(function(i){return i.beforeRoot&&i.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(i){const o={scene:i[0][n.scene||0],scenes:i[0],animations:i[1],cameras:i[2],asset:n.asset,parser:s,userData:{}};return Ue(r,o,n),Se(o,n),Promise.all(s._invokeAll(function(l){return l.afterRoot&&l.afterRoot(o)})).then(function(){for(const l of o.scenes)l.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const i=t[n].joints;for(let o=0,l=i.length;o<l;o++)e[i[o]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const i=e[n];i.mesh!==void 0&&(this._addNodeRef(this.meshCache,i.mesh),i.skin!==void 0&&(s[i.mesh].isSkinnedMesh=!0)),i.camera!==void 0&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(i,o)=>{const l=this.associations.get(i);l!=null&&this.associations.set(o,l);for(const[d,g]of i.children.entries())r(g,o.children[d])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":n=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(r,i){return s.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[W.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(r,i){s.load(ze.resolveURL(t.uri,n.path),r,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,r=t.byteOffset||0;return s.slice(r,r+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const i=Gt[n.type],o=tt[n.componentType],l=n.normalized===!0,d=new o(n.count*i);return Promise.resolve(new Ct(d,i,l))}const r=[];return n.bufferView!==void 0?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),n.sparse!==void 0&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(i){const o=i[0],l=Gt[n.type],d=tt[n.componentType],g=d.BYTES_PER_ELEMENT,h=g*l,y=n.byteOffset||0,T=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,x=n.normalized===!0;let v,A;if(T&&T!==h){const L=Math.floor(y/T),H="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+L+":"+n.count;let R=t.cache.get(H);R||(v=new d(o,L*T,n.count*T/g),R=new Tr(v,T/g),t.cache.add(H,R)),A=new Ir(R,l,y%T/g,x)}else o===null?v=new d(n.count*l):v=new d(o,y,n.count*l),A=new Ct(v,l,x);if(n.sparse!==void 0){const L=Gt.SCALAR,H=tt[n.sparse.indices.componentType],R=n.sparse.indices.byteOffset||0,B=n.sparse.values.byteOffset||0,J=new H(i[1],R,n.sparse.count*L),Q=new d(i[2],B,n.sparse.count*l);o!==null&&(A=new Ct(A.array.slice(),A.itemSize,A.normalized)),A.normalized=!1;for(let ee=0,V=J.length;ee<V;ee++){const z=J[ee];if(A.setX(z,Q[ee*l]),l>=2&&A.setY(z,Q[ee*l+1]),l>=3&&A.setZ(z,Q[ee*l+2]),l>=4&&A.setW(z,Q[ee*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}A.normalized=x}return A})}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,i=t.images[r];let o=this.textureLoader;if(i.uri){const l=s.manager.getHandler(i.uri);l!==null&&(o=l)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,s){const n=this,r=this.json,i=r.textures[e],o=r.images[t],l=(o.uri||o.bufferView)+":"+i.sampler;if(this.textureCache[l])return this.textureCache[l];const d=this.loadImageSource(t,s).then(function(g){g.flipY=!1,g.name=i.name||o.name||"",g.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(g.name=o.uri);const y=(r.samplers||{})[i.sampler]||{};return g.magFilter=Fn[y.magFilter]||kt,g.minFilter=Fn[y.minFilter]||Rt,g.wrapS=Pn[y.wrapS]||Oe,g.wrapT=Pn[y.wrapT]||Oe,g.generateMipmaps=!g.isCompressedTexture&&g.minFilter!==zn&&g.minFilter!==kt,n.associations.set(g,{textures:e}),g}).catch(function(){return null});return this.textureCache[l]=d,d}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const i=n.images[e],o=self.URL||self.webkitURL;let l=i.uri||"",d=!1;if(i.bufferView!==void 0)l=s.getDependency("bufferView",i.bufferView).then(function(h){d=!0;const y=new Blob([h],{type:i.mimeType});return l=o.createObjectURL(y),l});else if(i.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const g=Promise.resolve(l).then(function(h){return new Promise(function(y,T){let x=y;t.isImageBitmapLoader===!0&&(x=function(v){const A=new Ut(v);A.needsUpdate=!0,y(A)}),t.load(ze.resolveURL(h,r.path),x,void 0,T)})}).then(function(h){return d===!0&&o.revokeObjectURL(l),Se(h,i),h.userData.mimeType=i.mimeType||zi(i.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),h});return this.sourceCache[e]=g,g}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(i){if(!i)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(i=i.clone(),i.channel=s.texCoord),r.extensions[W.KHR_TEXTURE_TRANSFORM]){const o=s.extensions!==void 0?s.extensions[W.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const l=r.associations.get(i);i=r.extensions[W.KHR_TEXTURE_TRANSFORM].extendTexture(i,o),r.associations.set(i,l)}}return n!==void 0&&(i.colorSpace=n),e[t]=i,i})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,i=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+s.uuid;let l=this.cache.get(o);l||(l=new Er,Ft.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,l.sizeAttenuation=!1,this.cache.add(o,l)),s=l}else if(e.isLine){const o="LineBasicMaterial:"+s.uuid;let l=this.cache.get(o);l||(l=new vt,Ft.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,this.cache.add(o,l)),s=l}if(n||r||i){let o="ClonedMaterial:"+s.uuid+":";n&&(o+="derivative-tangents:"),r&&(o+="vertex-colors:"),i&&(o+="flat-shading:");let l=this.cache.get(o);l||(l=s.clone(),r&&(l.vertexColors=!0),i&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(o,l),this.associations.set(l,this.associations.get(s))),s=l}e.material=s}getMaterialType(){return Xn}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let i;const o={},l=r.extensions||{},d=[];if(l[W.KHR_MATERIALS_UNLIT]){const h=n[W.KHR_MATERIALS_UNLIT];i=h.getMaterialType(),d.push(h.extendParams(o,r,t))}else{const h=r.pbrMetallicRoughness||{};if(o.color=new ye(1,1,1),o.opacity=1,Array.isArray(h.baseColorFactor)){const y=h.baseColorFactor;o.color.setRGB(y[0],y[1],y[2],De),o.opacity=y[3]}h.baseColorTexture!==void 0&&d.push(t.assignTexture(o,"map",h.baseColorTexture,ue)),o.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,o.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(d.push(t.assignTexture(o,"metalnessMap",h.metallicRoughnessTexture)),d.push(t.assignTexture(o,"roughnessMap",h.metallicRoughnessTexture))),i=this._invokeOne(function(y){return y.getMaterialType&&y.getMaterialType(e)}),d.push(Promise.all(this._invokeAll(function(y){return y.extendMaterialParams&&y.extendMaterialParams(e,o)})))}r.doubleSided===!0&&(o.side=Gn);const g=r.alphaMode||Ht.OPAQUE;if(g===Ht.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,g===Ht.MASK&&(o.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&i!==Ke&&(d.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new Lt(1,1),r.normalTexture.scale!==void 0)){const h=r.normalTexture.scale;o.normalScale.set(h,h)}if(r.occlusionTexture!==void 0&&i!==Ke&&(d.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&i!==Ke){const h=r.emissiveFactor;o.emissive=new ye().setRGB(h[0],h[1],h[2],De)}return r.emissiveTexture!==void 0&&i!==Ke&&d.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,ue)),Promise.all(d).then(function(){const h=new i(o);return r.name&&(h.name=r.name),Se(h,r),t.associations.set(h,{materials:e}),r.extensions&&Ue(n,h,r),h})}createUniqueName(e){const t=ut.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(o){return s[W.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(l){return On(l,o,t)})}const i=[];for(let o=0,l=e.length;o<l;o++){const d=e[o],g=Ki(d),h=n[g];if(h)i.push(h.promise);else{let y;d.extensions&&d.extensions[W.KHR_DRACO_MESH_COMPRESSION]?y=r(d):y=On(new rt,d,t),n[g]={primitive:d,promise:y},i.push(y)}}return Promise.all(i)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],i=r.primitives,o=[];for(let l=0,d=i.length;l<d;l++){const g=i[l].material===void 0?ji(this.cache):this.getDependency("material",i[l].material);o.push(g)}return o.push(t.loadGeometries(i)),Promise.all(o).then(function(l){const d=l.slice(0,l.length-1),g=l[l.length-1],h=[];for(let T=0,x=g.length;T<x;T++){const v=g[T],A=i[T];let L;const H=d[T];if(A.mode===Re.TRIANGLES||A.mode===Re.TRIANGLE_STRIP||A.mode===Re.TRIANGLE_FAN||A.mode===void 0)L=r.isSkinnedMesh===!0?new $t(v,H):new Zt(v,H),L.isSkinnedMesh===!0&&L.normalizeSkinWeights(),A.mode===Re.TRIANGLE_STRIP?L.geometry=Sn(L.geometry,Kn):A.mode===Re.TRIANGLE_FAN&&(L.geometry=Sn(L.geometry,Kt));else if(A.mode===Re.LINES)L=new Vn(v,H);else if(A.mode===Re.LINE_STRIP)L=new Qt(v,H);else if(A.mode===Re.LINE_LOOP)L=new vr(v,H);else if(A.mode===Re.POINTS)L=new kr(v,H);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+A.mode);Object.keys(L.geometry.morphAttributes).length>0&&Vi(L,r),L.name=t.createUniqueName(r.name||"mesh_"+e),Se(L,r),A.extensions&&Ue(n,L,A),t.assignFinalMaterial(L),h.push(L)}for(let T=0,x=h.length;T<x;T++)t.associations.set(h[T],{meshes:e,primitives:T});if(h.length===1)return r.extensions&&Ue(n,h[0],r),h[0];const y=new Xe;r.extensions&&Ue(n,y,r),t.associations.set(y,{meshes:e});for(let T=0,x=h.length;T<x;T++)y.add(h[T]);return y})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new xt(me.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new jn(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),Se(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const r=n.pop(),i=n,o=[],l=[];for(let d=0,g=i.length;d<g;d++){const h=i[d];if(h){o.push(h);const y=new Z;r!==null&&y.fromArray(r.array,d*16),l.push(y)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[d])}return new en(o,l)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,i=[],o=[],l=[],d=[],g=[];for(let h=0,y=n.channels.length;h<y;h++){const T=n.channels[h],x=n.samplers[T.sampler],v=T.target,A=v.node,L=n.parameters!==void 0?n.parameters[x.input]:x.input,H=n.parameters!==void 0?n.parameters[x.output]:x.output;v.node!==void 0&&(i.push(this.getDependency("node",A)),o.push(this.getDependency("accessor",L)),l.push(this.getDependency("accessor",H)),d.push(x),g.push(v))}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(l),Promise.all(d),Promise.all(g)]).then(function(h){const y=h[0],T=h[1],x=h[2],v=h[3],A=h[4],L=[];for(let R=0,B=y.length;R<B;R++){const J=y[R],Q=T[R],ee=x[R],V=v[R],z=A[R];if(J===void 0)continue;J.updateMatrix&&J.updateMatrix();const Y=s._createAnimationTracks(J,Q,ee,V,z);if(Y)for(let $=0;$<Y.length;$++)L.push(Y[$])}const H=new wt(r,void 0,L);return Se(H,n),H})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(r){const i=s._getNodeRef(s.meshCache,n.mesh,r);return n.weights!==void 0&&i.traverse(function(o){if(o.isMesh)for(let l=0,d=n.weights.length;l<d;l++)o.morphTargetInfluences[l]=n.weights[l]}),i})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],r=s._loadNodeShallow(e),i=[],o=n.children||[];for(let d=0,g=o.length;d<g;d++)i.push(s.getDependency("node",o[d]));const l=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),l]).then(function(d){const g=d[0],h=d[1],y=d[2];y!==null&&g.traverse(function(T){T.isSkinnedMesh&&T.bind(y,Xi)});for(let T=0,x=h.length;T<x;T++)g.add(h[T]);return g})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],i=r.name?n.createUniqueName(r.name):"",o=[],l=n._invokeOne(function(d){return d.createNodeMesh&&d.createNodeMesh(e)});return l&&o.push(l),r.camera!==void 0&&o.push(n.getDependency("camera",r.camera).then(function(d){return n._getNodeRef(n.cameraCache,r.camera,d)})),n._invokeAll(function(d){return d.createNodeAttachment&&d.createNodeAttachment(e)}).forEach(function(d){o.push(d)}),this.nodeCache[e]=Promise.all(o).then(function(d){let g;if(r.isBone===!0?g=new Et:d.length>1?g=new Xe:d.length===1?g=d[0]:g=new Qe,g!==d[0])for(let h=0,y=d.length;h<y;h++)g.add(d[h]);if(r.name&&(g.userData.name=r.name,g.name=i),Se(g,r),r.extensions&&Ue(s,g,r),r.matrix!==void 0){const h=new Z;h.fromArray(r.matrix),g.applyMatrix4(h)}else r.translation!==void 0&&g.position.fromArray(r.translation),r.rotation!==void 0&&g.quaternion.fromArray(r.rotation),r.scale!==void 0&&g.scale.fromArray(r.scale);if(!n.associations.has(g))n.associations.set(g,{});else if(r.mesh!==void 0&&n.meshCache.refs[r.mesh]>1){const h=n.associations.get(g);n.associations.set(g,{...h})}return n.associations.get(g).nodes=e,g}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new Xe;s.name&&(r.name=n.createUniqueName(s.name)),Se(r,s),s.extensions&&Ue(t,r,s);const i=s.nodes||[],o=[];for(let l=0,d=i.length;l<d;l++)o.push(n.getDependency("node",i[l]));return Promise.all(o).then(function(l){for(let g=0,h=l.length;g<h;g++)r.add(l[g]);const d=g=>{const h=new Map;for(const[y,T]of n.associations)(y instanceof Ft||y instanceof Ut)&&h.set(y,T);return g.traverse(y=>{const T=n.associations.get(y);T!=null&&h.set(y,T)}),h};return n.associations=d(r),r})}_createAnimationTracks(e,t,s,n,r){const i=[],o=e.name?e.name:e.uuid,l=[];He[r.path]===He.weights?e.traverse(function(y){y.morphTargetInfluences&&l.push(y.name?y.name:y.uuid)}):l.push(o);let d;switch(He[r.path]){case He.weights:d=Vt;break;case He.rotation:d=at;break;case He.translation:case He.scale:d=ot;break;default:s.itemSize===1?d=Vt:d=ot;break}const g=n.interpolation!==void 0?Hi[n.interpolation]:qn,h=this._getArrayFromAccessor(s);for(let y=0,T=l.length;y<T;y++){const x=new d(l[y]+"."+He[r.path],t.array,h,g);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(x),i.push(x)}return i}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=qt(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof at?Gi:os;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Wi(m,e,t){const s=e.attributes,n=new Wn;if(s.POSITION!==void 0){const o=t.json.accessors[s.POSITION],l=o.min,d=o.max;if(l!==void 0&&d!==void 0){if(n.set(new ce(l[0],l[1],l[2]),new ce(d[0],d[1],d[2])),o.normalized){const g=qt(tt[o.componentType]);n.min.multiplyScalar(g),n.max.multiplyScalar(g)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const o=new ce,l=new ce;for(let d=0,g=r.length;d<g;d++){const h=r[d];if(h.POSITION!==void 0){const y=t.json.accessors[h.POSITION],T=y.min,x=y.max;if(T!==void 0&&x!==void 0){if(l.setX(Math.max(Math.abs(T[0]),Math.abs(x[0]))),l.setY(Math.max(Math.abs(T[1]),Math.abs(x[1]))),l.setZ(Math.max(Math.abs(T[2]),Math.abs(x[2]))),y.normalized){const v=qt(tt[y.componentType]);l.multiplyScalar(v)}o.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(o)}m.boundingBox=n;const i=new _r;n.getCenter(i.center),i.radius=n.min.distanceTo(n.max)/2,m.boundingSphere=i}function On(m,e,t){const s=e.attributes,n=[];function r(i,o){return t.getDependency("accessor",i).then(function(l){m.setAttribute(o,l)})}for(const i in s){const o=Xt[i]||i.toLowerCase();o in m.attributes||n.push(r(s[i],o))}if(e.indices!==void 0&&!m.index){const i=t.getDependency("accessor",e.indices).then(function(o){m.setIndex(o)});n.push(i)}return Ae.workingColorSpace!==De&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ae.workingColorSpace}" not supported.`),Se(m,e),Wi(m,e,t),Promise.all(n).then(function(){return e.targets!==void 0?Ui(m,e.targets,t):m})}function Yi(m){const e=new Map,t=new Map,s=m.clone();return as(m,s,function(n,r){e.set(r,n),t.set(n,r)}),s.traverse(function(n){if(!n.isSkinnedMesh)return;const r=n,i=e.get(n),o=i.skeleton.bones;r.skeleton=i.skeleton.clone(),r.bindMatrix.copy(i.bindMatrix),r.skeleton.bones=o.map(function(l){return t.get(l)}),r.bind(r.skeleton,r.bindMatrix)}),s}function as(m,e,t){t(m,e);for(let s=0;s<m.children.length;s++)as(m.children[s],e.children[s],t)}const Ji=/^(?:[a-z][a-z\d+\-.]*:)?\/\//i,nn=m=>{const e=m.split("?")[0]??m,t=e.lastIndexOf("/");return t<0?"":e.slice(0,t+1)},sn=(m,e)=>{if(!m||Ji.test(m)||m.startsWith("data:")||m.startsWith("blob:"))return m;const t=e.endsWith("/")?e:`${e}/`,s=t.replace(/^https?:\/\/[^/]+/i,"");let n=m.replace(/\\/g,"/");if(n.startsWith(t)||n.startsWith(s))return n;if(/^\/(images|textures|images_shiny|shiny)\//i.test(n))return n=n.replace(/^\/+/,""),`${t}${n}`;const r=["images_shiny/","images/","textures/","shiny/"],i=n.toLowerCase();for(const o of r){const l=i.lastIndexOf(o);if(l>=0){const d=n.slice(l).replace(/^\.\//,"");return`${t}${d}`}}return n.startsWith("/")?n:`${t}${n.replace(/^\.\//,"")}`},$i=m=>{m.traverse(e=>{const t=e;if(!t.isMesh)return;const s=Array.isArray(t.material)?t.material:[t.material];for(const n of s){if(!n)continue;const r=n;r.map&&(r.map.colorSpace=ue,r.map.generateMipmaps=!0,r.map.minFilter=Rt,r.map.magFilter=kt),n.needsUpdate=!0}})},rn=({scene:m})=>{const e=Dn.useMemo(()=>{const t=Yi(m);$i(t);const s=new Wn().setFromObject(t),n=new ce,r=new ce,i=s.min.clone();s.getSize(n),s.getCenter(r);const o=Math.max(n.x,n.y,n.z,.001),l=n.y>=o*.34,g=1.88/Math.max(l?n.y:o,.001);return{position:new ce(-r.x*g,-i.y*g-.9,-r.z*g),root:t,scale:g}},[m]);return xe.jsx("group",{position:e.position,rotation:[0,Math.PI,0],scale:e.scale,children:xe.jsx("primitive",{object:e.root})})},Zi=({modelUrl:m})=>{const e=tn(pi,m,t=>{const s=nn(m);t.manager.setURLModifier(n=>sn(n,s)),t.setResourcePath(s)});return xe.jsx(rn,{scene:e.scene})},Qi=({modelUrl:m})=>{const e=tn(Nr,m,t=>{const s=nn(m);t.manager.setURLModifier(n=>sn(n,s)),t.setResourcePath(s)});return xe.jsx(rn,{scene:e.scene})},eo=({modelUrl:m})=>{const e=tn(ni,m,t=>{const s=nn(m);t.manager.setURLModifier(n=>sn(n,s)),t.setResourcePath(s)});return xe.jsx(rn,{scene:e})},so=({modelUrl:m})=>{const e=/\.dae(?:\?|$)/i.test(m),t=/\.fbx(?:\?|$)/i.test(m);return xe.jsxs(Mr,{camera:{fov:28,position:[0,.2,6.4]},dpr:[1,1.5],frameloop:"demand",gl:{alpha:!0,antialias:!1,powerPreference:"default"},style:{height:"100%",width:"100%"},children:[xe.jsx("ambientLight",{intensity:.92}),xe.jsx("hemisphereLight",{intensity:.55}),xe.jsx("directionalLight",{intensity:1.08,position:[2,3,4]}),xe.jsx("directionalLight",{intensity:.32,position:[-2,1,-2]}),xe.jsx(Dn.Suspense,{fallback:null,children:e?xe.jsx(Qi,{modelUrl:m}):t?xe.jsx(eo,{modelUrl:m}):xe.jsx(Zi,{modelUrl:m})})]})};export{so as PokemonModelCanvas};
